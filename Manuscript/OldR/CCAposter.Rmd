---
title: "Import OLIS spectral data data"
author: "Douglas A. Campbell, Sylwia Sliwinska-Wilczewska, Sarah Gore, Adrian Kryk"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---

# Import spectral files generated by OLIS spectrophotometer

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

```{r set project variables}
Project <- "PICO"
DataOut <- file.path("..", "ImportedData", "PUR")
DataIn <- file.path("..", "OLISSpectraCorr", "SySlCCASingleChosen", fsep = .Platform$file.sep)
FileID <- "Smooth"
FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```


```{r load libraries} 
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)

library(dplyr)
library(magrittr)
library(googledrive)
library(googlesheets4)
library(readxl)

library(ggspectra)
library(ggpubr)
library(caret)

library(photobiologyWavebands)
library(reshape2)
library(photobiology)
library(extrafont)
```

```{r set colours}
Wavelengths_nm = c(445, 470, 505, 535, 590)
Colours_nm = c("darkblue", "dodgerblue", "darkgreen", "yellowgreen",  "darkorange")

names(Colours_nm) <- Wavelengths_nm
Colours_nm

```

For SySl files 'baseline' in filename means baseline spectra already subtracted within OLIS software.
This was not universallly true across all projects; be careful.
For SySl files 'raw' means spectra of undiluted culture; other spectra are 1 or 4 ml culture + 8 or 4 ml media.

Ideally: we want to read and tidy some user-selected set of files taken from multiple dates

```{r list available OLIS Files}
OlisFiles <- list.files(path = DataIn, pattern = FileID, full.names = TRUE)
OlisFiles
unique(duplicated(OlisFiles))
```


# set up read_delim_plus
```{r}

read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
     mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime))
}

#read.delim_long meant for map over a vector of filepaths to read, convert to long format and tidy the imported data
read.delim_long <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
    mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime)) %>%
 rename(nm = OLIS.3D.ASCII) %>%
  mutate(FirstLastSpec = str_extract(Filename, "_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_")) %>%
  mutate(SampleNumbers = str_extract_all(FirstLastSpec, "[:digit:][:digit:][:digit:][:digit:]")) %>%
  mutate(FirstSampleNumber = as.numeric(map(SampleNumbers, ~.[[1]]))) %>%
  mutate(LastSampleNumber = as.numeric(map(SampleNumbers, ~.[[2]]))) %>%
  mutate(OperatorID = str_extract(Filename,"[A-Z][a-z][A-Z][a-z]")) %>%
  pivot_longer(cols = starts_with("X"), names_to = "SpectraID", values_to = "Abs") %>%
  mutate(SampleCode = as.numeric(str_remove(SpectraID, "X"))) %>%
  mutate(SampleNumber = SampleCode - min(SampleCode, na.rm = TRUE) + FirstSampleNumber) %>%
  relocate(OperatorID, SampleNumber) %>%
  unite(col = SampleID, OperatorID:SampleNumber, sep = "", remove = FALSE) %>%
  arrange(SampleID, nm) %>%
  relocate(SampleID, nm, Abs) %>%
  mutate(SpectraDate = str_extract(Filename, "/[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
         SpectraDate = str_remove_all(SpectraDate, "_"),
         SpectraDate = str_remove_all(SpectraDate, "/"),
         SpectraDate = ymd(SpectraDate)
  )
}
```


# Import OLISSpectra corrected files
```{r import from specific OLIS corrected file containing multiple spectra}

TargetFile <-  OlisFiles
TargetSpectra <- TargetFile %>% map_df(~read.delim_plus(flnm = ., filencode = FileEncode, delimiter = Delimiter, headerrows = HeaderRows)) %>% 
  pivot_longer(., -c(`OLIS.3D.ASCII`, Filename, Cdatetime), values_to = "Absorbance", names_to = "SampleID") %>%
  filter(!is.na(Absorbance)) %>%
  rename(nm = `OLIS.3D.ASCII`)   
  #separate(col = SampleID, into = c("SampleID", "Replicate"), sep = "_")
TargetSpectraLong <- TargetSpectra %>%
  # rename(nm = OLIS.3D.ASCII) %>%
  separate(col = Filename, into = c("fp1", "fp2", "fp3", "SpectraDate", "Project", "Source", "Range", "Type", "Correction", "Smooth"), sep = "([\\/\\_\\:])", remove = FALSE) 

TargetSpectraLong2 <- TargetSpectraLong %>%
  select(-c(fp1, fp2, fp3, Type, Correction, Smooth, SampleID)) %>% 
  rename(CultureID = Source) %>% 
  mutate(SpectraDate = ymd(`SpectraDate`)) 
```

Load Multiculti catalog
```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

MetaData <- read_sheet("https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0") %>%
  drop_na(WL) %>%
  mutate(WL = unlist(WL))

as.data.frame(MetaData)
MetaData <- MetaData %>%
   mutate(ExpDate = ymd(ExpDate),
          ExpEndDate = ymd_hms(`ExpEndDate`))
```


# Merge OLISSpectra with MetaData
```{r OLISDateSpectra with MetaData}

OLISSpectraMeta <- MetaData %>%
  left_join(., TargetSpectraLong2, by = c("ID" = "CultureID")) %>% 
  filter(Run == "70") 

OLISSpectraMeta <- OLISSpectraMeta %>%
  rename("FilenameOlis" = "Filename") %>% 
  select(-c(PrimaryOperator, doi, ProjectID, Inoc_mL, Media_mL, InnocDate, Tube, Plate, Well, Salinity,  N2, Ar, CO2, Media, MediaDate, SourceSalinity, OptodeCh, InocpH, FinalpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, ...44, ...45, Description, Motivation, MC, EndDate,  ExpCul, ExpStartTime, Source, Optode, Range, Cdatetime, Project))
          
OLISSpectraMeta <- OLISSpectraMeta %>%
group_by(ID) %>%
  arrange(SpectraDate) %>%
  mutate(E_days = as.numeric((SpectraDate - ExpDate[1]))) %>%
  mutate(SumAb = sum(Absorbance)) %>% 
ungroup()

OLISSpectraMeta <- OLISSpectraMeta %>%
  filter(nm >= 400 & nm <= 700)
```

Normalization at 440
```{r}

Absorbance440 <- OLISSpectraMeta %>% 
  filter(nm == 440) %>%
  mutate(Abs440 = Absorbance) %>%
  select(ID, Strain, Abs440, Par_ue)
  
OLISSpectraMeta440 <- OLISSpectraMeta %>%
  left_join(., Absorbance440) %>%
  mutate(AbsNorm440 = Absorbance / Abs440) 
  
OLISSpectraMeta440 <- OLISSpectraMeta440 %>%
group_by(ID) %>%
  mutate(SumAbNorm = sum(AbsNorm440)) %>% 
ungroup()

```


#Combine OLISspectra with Jaz spectra
Jaz file
```{r}
Project <- "PICO"
DataIn <- file.path("..", "ImportedData", "Jaz", fsep = .Platform$file.sep)

FileEncode <- "UTF-8" 
Delimiter <- ","

HeaderRows <- 0
```

Jaz file
Exported from PICO_SySlJazSpec_MultiCulti.Rmd only first time in session
```{r list tidied data files}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

Jaz file
```{r read ProcessFile}
JazFile <- "../ImportedData/Jaz/PICO_PICO_MultiCultiSpectra_660_530_par.Rds"

JazFileName <- str_split(string = JazFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

JazData <- readRDS(JazFile)  %>%
  ungroup()

colnames(JazData)
```

```{r}
JazData <- JazData %>%
   mutate(WavelengthRound = round(Wavelength))
colnames(JazData)

JazDataRound <- JazData %>%
group_by(Filename, WavelengthRound) %>%
  summarize(Counts, Filename, Instrument, Date, Strain, Par, WL, CDateTime, WavelengthRound, CountsMean = mean(Counts)) %>% 
ungroup()

JazDataRound <- JazDataRound %>%
  summarize(Filename, Strain, Par, WL, WavelengthRound, CountsMean) %>%
  unique()

JazDataRound <- JazDataRound %>%
  filter(WavelengthRound >= 400 & WavelengthRound <= 700) 

```


Normalization at 647
```{r}

EmissionJazRed <- JazDataRound %>% 
  group_by(WL, Strain, Par) %>% 
  filter(WL == "660") %>%
  filter(WavelengthRound == 647) %>%
  mutate(EmJaz647 = CountsMean) %>% 
  select(Strain, EmJaz647, Par) %>% 
  ungroup()
  
JazDataRoundRedMeta <- JazDataRound %>%
  left_join(., EmissionJazRed) %>%
  mutate(EmNormJaz647 = CountsMean / EmJaz647) 
  
```

Normalization at 521
```{r}

EmissionJazGreen <- JazDataRound %>% 
  group_by(WL, Strain, Par) %>% 
  filter(WL == "530") %>%
  filter(WavelengthRound == 521) %>%
  mutate(EmJaz521 = CountsMean) %>% 
  select(Strain, EmJaz521, Par) %>% 
  ungroup()
  
JazDataRoundGreenMeta <- JazDataRound %>%
  left_join(., EmissionJazGreen) %>%
  mutate(EmNormJaz521 = CountsMean / EmJaz521) 
  
```


```{r}
JazDataRoundMetaAll2 <- JazDataRoundRedMeta %>%

  left_join(., JazDataRoundGreenMeta, by = c("Par" = "Par", "WavelengthRound" = "WavelengthRound", "Strain" = "Strain", "WL" = "WL", "Filename" = "Filename", "CountsMean" = "CountsMean")) %>%
  unique()

```


```{r}

OLISSpectraMetaAll <- OLISSpectraMeta440 %>%
  
  left_join(., JazDataRoundMetaAll2, by = c("Par_ue" = "Par", "nm" = "WavelengthRound", "Strain" = "Strain", "WL" = "WL")) %>% 
  unique()

```


Mireille idea
```{r}

OLISSpectraMetaAllPUR2 <- OLISSpectraMetaAll %>%

  mutate(PURNormRed = (AbsNorm440*EmNormJaz647)) %>% # green line
  mutate(PURNormGreen = (AbsNorm440*EmNormJaz521)) %>% # green line
  
  group_by(WL, Strain, Par_ue) %>% 
  mutate(PURNormRedSum = sum(PURNormRed)) %>% #sum of the green line
  mutate(PURNormGreenSum = sum(PURNormGreen)) %>% #sum of the green line
  mutate(SumEmNormJaz647 = sum(EmNormJaz647)) %>% #sum of the blue line
  mutate(SumEmNormJaz521 = sum(EmNormJaz521)) %>% #sum of the blue line
  ungroup() %>% 
  
  mutate(PUR_Red = Par_ue*(PURNormRedSum/SumEmNormJaz647)) %>% 
  mutate(PUR_Green = Par_ue*(PURNormGreenSum/SumEmNormJaz521)) 

```



#Good PUR Data
Jaz file
```{r}
Project <- "PICO"
DataIn <- file.path("..", "ImportedData", "PUR", fsep = .Platform$file.sep)

FileEncode <- "UTF-8" 
Delimiter <- ","

HeaderRows <- 0
```

Jaz file
Exported from PICO_SySlJazSpec_MultiCulti.Rmd only first time in session
```{r list tidied data files}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```
Jaz file
```{r read ProcessFile}
JazFile <- "../ImportedData/PUR/PICO_PURSySlRedGreenMultiCultiAll.Rds"

JazFileName <- str_split(string = JazFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

JazData <- readRDS(JazFile)  %>%
  ungroup()

OLISSpectraMetaAllPUR4 <- JazData
```


Divided PUR into PUR660 and PUR530
```{r}
OLISSpectraMetaAllPUR5 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA127R") %>% 
  filter(Par_ue == 60) %>% 
  filter(WL == "530") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA127R_60_660.txt") %>% 
  mutate(PUR660 = PUR*1) %>% 
  mutate(PUR530 = NA) %>% 
  mutate(EmNormJaz660 = EmNormJaz*1) %>% 
  mutate(EmNormJaz530 = NA) %>%
  mutate(PURNorm660 = PURNorm*1) %>% 
  mutate(PURNorm530 = NA) 

OLISSpectraMetaAllPUR6 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA127R") %>% 
  filter(Par_ue == 60) %>% 
  filter(WL == "530") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA127R_60_530.txt") %>% 
  mutate(PUR530 = PUR*1) %>% 
  mutate(PUR660 = NA) %>% 
  mutate(EmNormJaz530 = EmNormJaz*1) %>% 
  mutate(EmNormJaz660 = NA) %>%
  mutate(PURNorm530 = PURNorm*1) %>% 
  mutate(PURNorm660 = NA) 

OLISSpectraMetaAllPUR7 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA127R") %>% 
  filter(Par_ue == 60) %>% 
  filter(WL == "660") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA127R_60_660.txt") %>% 
  mutate(PUR660 = PUR*1) %>% 
  mutate(PUR530 = NA) %>% 
  mutate(EmNormJaz660 = EmNormJaz*1) %>% 
  mutate(EmNormJaz530 = NA) %>%
  mutate(PURNorm660 = PURNorm*1) %>% 
  mutate(PURNorm530 = NA) 

OLISSpectraMetaAllPUR8 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA127R") %>% 
  filter(Par_ue == 60) %>% 
  filter(WL == "660") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA127R_60_530.txt") %>% 
  mutate(PUR530 = PUR*1) %>% 
  mutate(PUR660 = NA) %>% 
  mutate(EmNormJaz530 = EmNormJaz*1) %>% 
  mutate(EmNormJaz660 = NA) %>%
  mutate(PURNorm530 = PURNorm*1) %>% 
  mutate(PURNorm660 = NA) 

OLISSpectraMetaAllPUR9 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA127R") %>% 
  filter(Par_ue == 300) %>% 
  filter(WL == "530") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA127R_300_660.txt") %>% 
  mutate(PUR660 = PUR*1) %>% 
  mutate(PUR530 = NA) %>% 
  mutate(EmNormJaz660 = EmNormJaz*1) %>% 
  mutate(EmNormJaz530 = NA) %>%
  mutate(PURNorm660 = PURNorm*1) %>% 
  mutate(PURNorm530 = NA) 

OLISSpectraMetaAllPUR10 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA127R") %>% 
  filter(Par_ue == 300) %>% 
  filter(WL == "530") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA127R_300_530.txt") %>% 
  mutate(PUR530 = PUR*1) %>% 
  mutate(PUR660 = NA) %>% 
  mutate(EmNormJaz530 = EmNormJaz*1) %>% 
  mutate(EmNormJaz660 = NA) %>%
  mutate(PURNorm530 = PURNorm*1) %>% 
  mutate(PURNorm660 = NA) 

OLISSpectraMetaAllPUR11 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA127R") %>% 
  filter(Par_ue == 300) %>% 
  filter(WL == "660") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA127R_300_660.txt") %>% 
  mutate(PUR660 = PUR*1) %>% 
  mutate(PUR530 = NA) %>% 
  mutate(EmNormJaz660 = EmNormJaz*1) %>% 
  mutate(EmNormJaz530 = NA) %>%
  mutate(PURNorm660 = PURNorm*1) %>% 
  mutate(PURNorm530 = NA) 

OLISSpectraMetaAllPUR12 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA127R") %>% 
  filter(Par_ue == 300) %>% 
  filter(WL == "660") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA127R_300_530.txt") %>% 
  mutate(PUR530 = PUR*1) %>% 
  mutate(PUR660 = NA) %>% 
  mutate(EmNormJaz530 = EmNormJaz*1) %>% 
  mutate(EmNormJaz660 = NA) %>%
  mutate(PURNorm530 = PURNorm*1) %>% 
  mutate(PURNorm660 = NA) 



OLISSpectraMetaAllPUR13 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA77G") %>% 
  filter(Par_ue == 60) %>% 
  filter(WL == "530") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA77G_60_660.txt") %>% 
  mutate(PUR660 = PUR*1) %>% 
  mutate(PUR530 = NA) %>% 
  mutate(EmNormJaz660 = EmNormJaz*1) %>% 
  mutate(EmNormJaz530 = NA) %>%
  mutate(PURNorm660 = PURNorm*1) %>% 
  mutate(PURNorm530 = NA) 

OLISSpectraMetaAllPUR14 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA77G") %>% 
  filter(Par_ue == 60) %>% 
  filter(WL == "530") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA77G_60_530.txt") %>% 
  mutate(PUR530 = PUR*1) %>% 
  mutate(PUR660 = NA) %>% 
  mutate(EmNormJaz530 = EmNormJaz*1) %>% 
  mutate(EmNormJaz660 = NA) %>%
  mutate(PURNorm530 = PURNorm*1) %>% 
  mutate(PURNorm660 = NA) 

OLISSpectraMetaAllPUR15 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA77G") %>% 
  filter(Par_ue == 60) %>% 
  filter(WL == "660") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA77G_60_660.txt") %>% 
  mutate(PUR660 = PUR*1) %>% 
  mutate(PUR530 = NA) %>% 
  mutate(EmNormJaz660 = EmNormJaz*1) %>% 
  mutate(EmNormJaz530 = NA) %>%
  mutate(PURNorm660 = PURNorm*1) %>% 
  mutate(PURNorm530 = NA) 

OLISSpectraMetaAllPUR16 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA77G") %>% 
  filter(Par_ue == 60) %>% 
  filter(WL == "660") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA77G_60_530.txt") %>% 
  mutate(PUR530 = PUR*1) %>% 
  mutate(PUR660 = NA) %>% 
  mutate(EmNormJaz530 = EmNormJaz*1) %>% 
  mutate(EmNormJaz660 = NA) %>%
  mutate(PURNorm530 = PURNorm*1) %>% 
  mutate(PURNorm660 = NA) 

OLISSpectraMetaAllPUR17 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA77G") %>% 
  filter(Par_ue == 300) %>% 
  filter(WL == "530") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA77G_300_660.txt") %>% 
  mutate(PUR660 = PUR*1) %>% 
  mutate(PUR530 = NA) %>% 
  mutate(EmNormJaz660 = EmNormJaz*1) %>% 
  mutate(EmNormJaz530 = NA) %>%
  mutate(PURNorm660 = PURNorm*1) %>% 
  mutate(PURNorm530 = NA) 

OLISSpectraMetaAllPUR18 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA77G") %>% 
  filter(Par_ue == 300) %>% 
  filter(WL == "530") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA77G_300_530.txt") %>% 
  mutate(PUR530 = PUR*1) %>% 
  mutate(PUR660 = NA) %>% 
  mutate(EmNormJaz530 = EmNormJaz*1) %>% 
  mutate(EmNormJaz660 = NA) %>%
  mutate(PURNorm530 = PURNorm*1) %>% 
  mutate(PURNorm660 = NA) 

OLISSpectraMetaAllPUR19 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA77G") %>% 
  filter(Par_ue == 300) %>% 
  filter(WL == "660") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA77G_300_660.txt") %>% 
  mutate(PUR660 = PUR*1) %>% 
  mutate(PUR530 = NA) %>% 
  mutate(EmNormJaz660 = EmNormJaz*1) %>% 
  mutate(EmNormJaz530 = NA) %>%
  mutate(PURNorm660 = PURNorm*1) %>% 
  mutate(PURNorm530 = NA) 

OLISSpectraMetaAllPUR20 <- OLISSpectraMetaAllPUR4 %>% 
  filter(Strain == "BA77G") %>% 
  filter(Par_ue == 300) %>% 
  filter(WL == "660") %>% 
  filter(Filename == "OLISSpectraCorr/20221130_BA77G_300_530.txt") %>% 
  mutate(PUR530 = PUR*1) %>% 
  mutate(PUR660 = NA) %>% 
  mutate(EmNormJaz530 = EmNormJaz*1) %>% 
  mutate(EmNormJaz660 = NA) %>%
  mutate(PURNorm530 = PURNorm*1) %>% 
  mutate(PURNorm660 = NA) 

OLISSpectraMetaAllPURDivided <- rbind(OLISSpectraMetaAllPUR5, OLISSpectraMetaAllPUR6, OLISSpectraMetaAllPUR7, OLISSpectraMetaAllPUR8, OLISSpectraMetaAllPUR9, OLISSpectraMetaAllPUR10, OLISSpectraMetaAllPUR11, OLISSpectraMetaAllPUR12, OLISSpectraMetaAllPUR13, OLISSpectraMetaAllPUR14, OLISSpectraMetaAllPUR15, OLISSpectraMetaAllPUR16, OLISSpectraMetaAllPUR17, OLISSpectraMetaAllPUR18, OLISSpectraMetaAllPUR19, OLISSpectraMetaAllPUR20)


#str(OLISSpectraMetaAllPURDivided)

```

```{r}
OLISSpectraMetaAllPURDivided2 <- OLISSpectraMetaAllPURDivided %>% 
  mutate(Filename = as.factor(Filename)) %>% 
  mutate(WL = as.factor(WL))
#str(OLISSpectraMetaAllPURDivided2)
```



combined PUR
```{r}
OLISSpectraMetaAllPURCombineRed <- OLISSpectraMetaAllPUR2 %>%
  select(-c(PUR_Green)) %>% 
  filter(PUR_Red >= 31 & PUR_Red <= 196) %>% 
  rename("PUR" = "PUR_Red") %>% 
  mutate(PUR_WL = 660) %>% 
  select(-c(EmJaz521, EmNormJaz521, PURNormGreen, PURNormGreenSum, SumEmNormJaz521)) %>% 
  rename("EmJaz" = "EmJaz647", "EmNormJaz" = "EmNormJaz647", "PURNorm" = "PURNormRed", "PURNormSum" = "PURNormRedSum", "SumEmNormJaz" = "SumEmNormJaz647") 

OLISSpectraMetaAllPURCombineGreen <- OLISSpectraMetaAllPUR2 %>%
  select(-c(PUR_Red)) %>% 
  filter(PUR_Green >= 28 & PUR_Green <= 202) %>% 
  rename("PUR" = "PUR_Green") %>% 
  mutate(PUR_WL = 530) %>% 
  select(-c(EmJaz647, EmNormJaz647, PURNormRed, PURNormRedSum, SumEmNormJaz647)) %>% 
  rename("EmJaz" = "EmJaz521", "EmNormJaz" = "EmNormJaz521", "PURNorm" = "PURNormGreen", "PURNormSum" = "PURNormGreenSum", "SumEmNormJaz" = "SumEmNormJaz521") 

  PURCombined <- rbind(OLISSpectraMetaAllPURCombineRed, OLISSpectraMetaAllPURCombineGreen)
  
  PURCombinedRound2 <- PURCombined %>% 
  mutate(PURround = round(PUR, 0))

```


#PAR vs PUR

MultiCulti Assesment
```{r}
Project <- "PICO"
DataIn <- file.path("..","GrowthAssessData", fsep = .Platform$file.sep)
FileEncode <- "UTF-8" 
Delimiter <- ","
HeaderRows <- 0
```


MultiCulti Assesment
Exported only first time in session
```{r list tidied data files}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```


MultiCulti Assesment
```{r read ProcessFile}
MultiCultiFile <- "../GrowthAssessData/PICO_MultiAssesment_CCA.Rds"

MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

MultiCultiData <- readRDS(MultiCultiFile)  %>%
  ungroup()

colnames(MultiCultiData)
```

```{r}
MultiCultiDataClean <- MultiCultiData %>%
  summarize(Filename, Run, ID, Strain, Par_ue, Photoperiod, O2, WL, OD720_Lmu_corr, deltaOD_Lmu_corr,         OD720_LseGrowthFlag, deltaOD_LseGrowthFlag, GrowthAmpOD720Flag_14days, GrowthAmpdeltaODFlag_14days, OD720_Lmu_se, deltaOD_Lmu_se)

#OD720_Lmu_se, deltaOD_Lmu_se
```


```{r}
MultiCultiDataClean <- MultiCultiDataClean %>%
  group_by(Strain, Par_ue, WL) %>%

  summarize(Filename, Run, ID, Strain, Par_ue, Photoperiod, O2, WL, OD720_Lmu_corr, deltaOD_Lmu_corr,         OD720_LseGrowthFlag, deltaOD_LseGrowthFlag, GrowthAmpOD720Flag_14days, GrowthAmpdeltaODFlag_14days, OD720_Lmu_se, deltaOD_Lmu_se,
            meanOD720_Lmu_corr = mean(OD720_Lmu_corr),
            meandeltaOD_Lmu_corr = mean(deltaOD_Lmu_corr),
            seOD720_Lmu_corr = sd(OD720_Lmu_corr)/n()^(1/2),
            sedeltaOD_Lmu_corr = sd(deltaOD_Lmu_corr)/n()^(1/2),
            sdOD720_Lmu_corr = sd(OD720_Lmu_corr),
            sddeltaOD_Lmu_corr = sd(deltaOD_Lmu_corr)) %>%

  ungroup()
```

Join MultiCultiGrowth with Olis/Jaz PUR data
```{r}

PARvsPUR <- PURCombinedRound2 %>%
  rename("FilenameJaz" = "Filename") %>% 
  
  left_join(., MultiCultiDataClean, by = c("Par_ue" = "Par_ue", "Strain" = "Strain", "WL" = "WL", "Run" = "Run", "ID" = "ID", "O2" = "O2", "Photoperiod" = "Photoperiod")) %>% 
  unique()

#OLISSpectraMetaAllPUR4
```





Join MultiCultiGrowth with Olis/Jaz PUR data
```{r}
#colnames(MultiCultiDataClean)

# [1] "Strain"                      "Par_ue"                      "WL"                         
#  [4] "Filename"                    "Run"                         "ID"                         
#  [7] "Photoperiod"                 "O2"                          "OD720_Lmu_corr"             
# [10] "deltaOD_Lmu_corr"            "OD720_LseGrowthFlag"         "deltaOD_LseGrowthFlag"      
# [13] "GrowthAmpOD720Flag_14days"   "GrowthAmpdeltaODFlag_14days" "OD720_Lmu_se"               
# [16] "deltaOD_Lmu_se"              "meanOD720_Lmu_corr"          "meandeltaOD_Lmu_corr"       
# [19] "seOD720_Lmu_corr"            "sedeltaOD_Lmu_corr"          "sdOD720_Lmu_corr"           
# [22] "sddeltaOD_Lmu_corr" 

#colnames(OLISSpectraMetaAllPUR4)

# [1] "Run"                           "ID"                            "Strain"                       
#  [4] "ExpDate"                       "Par_ue"                        "Photoperiod"                  
#  [7] "Calculated_µmolPhotons_m-2d-1" "Temp_c"                        "O2"                           
# [10] "O2_Category"                   "WL"                            "LightShape"                   
# [13] "ExpEndDate"                    "nm"                            "FilenameOlis"                 
# [16] "SpectraDate"                   "Absorbance"                    "E_days"                       
# [19] "SumAb"                         "Abs440"                        "AbsNorm440"                   
# [22] "Filename"                      "CountsMean"                    "EmJaz"                        
# [25] "EmNormJaz"                     "PURNorm"                       "PURNormSum"                   
# [28] "SumEmNormJaz"                  "PUR" 

PARvsPUR2 <- OLISSpectraMetaAllPUR4 %>%
  rename("FilenameJaz" = "Filename") %>% 
  
  full_join(., MultiCultiDataClean, by = c("Par_ue" = "Par_ue", "Strain" = "Strain", "WL" = "WL", "Run" = "Run", "ID" = "ID", "O2" = "O2", "Photoperiod" = "Photoperiod")) 

PARvsPUR3 <- PARvsPUR2 %>% 
  filter(Strain == "BA127R" | Strain == "BA77G") %>%
  filter(Photoperiod == "12") %>%
  filter(WL != "WW") %>%
  filter(WL != "450") %>%
  filter(WL != "620") %>%
  filter(Par_ue != "180") %>%
  filter(Par_ue == "60"| Par_ue == "300") 
#OLISSpectraMetaAllPUR4
```



# Comparison Multiculti Import and raw Olis data

# Add MultiCulti Data
MultiCulti Import
```{r}
Project <- "PICO"
DataIn <- file.path("..", "ImportedData", "MultiCultiImport", fsep = .Platform$file.sep)
FileEncode <- "UTF-8" 
Delimiter <- ","
HeaderRows <- 0
```

MultiCulti Import
Exported only first time in session
```{r list tidied data files}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

MultiCulti Import
```{r read ProcessFile}
MultiCultiFile <- "../ImportedData/MultiCultiImport/PICO_TargetDataMetaFilter_RUN70.Rds"

MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

MultiCultiData <- readRDS(MultiCultiFile)  %>%
  ungroup()

colnames(MultiCultiData)
```

O2 file
```{r set project variables}
#"..", takes up a level in the directory path
Project <- "PICO"
FileID <- "caloxy"
DataIn <- file.path("..","ImportedData", "Optode")
DataOut <- file.path("..","ProcessedData", "CCA")
FileEncode <- "UTF-8" 
Delimiter <- "\t"

```

O2 file
Exported from O2Import_PyroOxyLog.Rmd only first time in session
```{r list tidied data files}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

Read O2Import_PyroOxyLog File
```{r read ImportedFile}
O2ProcessFile <- "../ImportedData/Optode/PICO_O2DataCatalogSySlCCACaloxyBiolStepsAL.Rds"

O2ProcessFileName <- str_split(string = O2ProcessFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

O2ProcessData <- readRDS(O2ProcessFile) %>%
  ungroup()

colnames(O2ProcessData)
```

```{r}
O2ProcessDataClean <- O2ProcessData %>% 
   rename("DateOptode" = "Date", "AbsTimeOptode" = "AbsTime", "filenameOptode" = "filename", "RunDateOptode" = "RunDate", "Temp_COptode" = "Temp_C") %>% 
  select(-c(Par_ueAdjusted, OptodeCh, OptodeCh, N2, Well, ElaspedHoursAtAdjustment, FinalpH, Ar, Salinity, Plate, doi, DateOfAdjustment, InocpH, SourceSalinity, Media, Motivation, Exp_Type, Inoc_mL, Media_mL, PrimaryOperator, Project, MediaDate, FileID, FileTime, ProjectID, InnocDate, CO2, ExpStartTime, MC, Source, EndDate, Description, ExpCul, ...44, ...45, LR_s, O2_umolL, Temp_COptode, AbsTimeOptode, Optode, ActinicAll)) 

colnames(O2ProcessDataClean)
```


Turner file
```{r}
Project <- "PICO"
DataIn <- file.path("..", "ImportedData", "Turner", fsep = .Platform$file.sep)

FileEncode <- "UTF-8" 
Delimiter <- ","

HeaderRows <- 0
```

Turner file
Exported from ChlTurnerPICO.Rmd only first time in session
```{r list tidied data files}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

Turner file
```{r read ProcessFile}
TurnerFile <- "../ImportedData/Turner/PICO_ChlTurnerAll.Rds"

TurnerFileName <- str_split(string = TurnerFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

TurnerData <- readRDS(TurnerFile)  %>%
  ungroup()

colnames(TurnerData)
```

```{r warning = FALSE}
O2MetaAll <- TurnerData %>%
  left_join(., O2ProcessDataClean, by = c("CultureID" = "CultureID", "Run" = "Run", "Strain" = "Strain", "ExpDate" = "ExpDate", "Par_ue" = "Par_ue", "Photoperiod" = "Photoperiod", "Calculated_µmolPhotons_m-2d-1" = "Calculated_µmolPhotons_m-2d-1", "Tube" = "Tube", "WL" = "WL", "O2" = "O2", "LightShape" = "LightShape", "DATE" = "DateOptode")) %>% 
  unique()

colnames(O2MetaAll)
```
For BiolSteps
```{r}
O2MetaAll2 <- O2MetaAll %>%
  subset(ActinicRate =='0'|
          ActinicRate =='1'|
          ActinicRate =='10'|
         ActinicRate =='20'|
         ActinicRate =='40'|
         ActinicRate =='80'|
         ActinicRate =='160'|
         ActinicRate =='320')  

O2MetaAll3 <- O2MetaAll2 %>%
  select(-c(Chl_ugL, Chl_ugmL, cellsml, Chla_ugN)) %>% 
  unique()
```


```{r}

O2MetaAllbiomass <- O2MetaAll3 %>% 
#meanO2RateSteps (umolO2/L/min) -> (umolO2/ml/s)
  mutate(meanO2Rate_umolmLs = meanO2RateSteps/1000*60) %>% 
  
#meanO2Rate_umolmLs (umolO2/ml/s) -> (umolO2/cell/s)
  mutate(meanO2Rate_umolcells = meanO2Rate_umolmLs/meancellsml) %>% 
  
#meanO2Rate_umolmLs (umolO2/ml/s) -> (umolO2/ug chla/s)
  mutate(meanO2Rate_umolugchlas = meanO2Rate_umolmLs/meanChl_ugmL) %>% 
  
#meanO2Rate_umolugchla (umolO2/ug chla/s) -> (umolO2/mg chla/s)
  mutate(meanO2Rate_umolmgchlas = meanO2Rate_umolugchlas*1000) 
  
```



```{r}
OxyEvobiomassMean <- O2MetaAllbiomass %>%
  #filter(meanO2Rate_umolmgchlas > -300) %>% #fixes the problem with 3 odd points

  group_by(Strain, WL, Ex_WL, Par_ue, ActinicRate) %>%
  
  summarize(CultureID, DATE, Run, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, `Calculated_µmolPhotons_m-2d-1`, Tube, O2, WL, LightShape, meanChl_ugmL, sdChl_ugmL, E_days, meancellsml, sdcellsml, meanChla_ugN, sdChla_ugN, filenameOptode, O2RateAll, meanO2RateSteps, ActinicRate, RunDateOptode, Ex_WL, LR_sLightAll, meanO2_umolL, seO2_umolL, sdO2_umolL, Temp_c, O2_Category, ExpEndDate, meanO2Rate_umolmLs, meanO2Rate_umolcells, meanO2Rate_umolugchlas, meanO2Rate_umolmgchlas, 
    
            meanOxyEvo_umolO2mLs = mean(meanO2Rate_umolmLs), 
            sdOxyEvo_umolO2mLs = sd(meanO2Rate_umolmLs),
            seOxyEvo_umolO2mLs = sd(meanO2Rate_umolmLs)/n()^(1/2), 
  
            meanOxyEvo_umolO2cells = mean(meanO2Rate_umolcells), 
            sdOxyEvo_umolO2cells = sd(meanO2Rate_umolcells),
            seOxyEvo_umolO2cells = sd(meanO2Rate_umolcells)/n()^(1/2), 
  
            meanOxyEvo_umolO2mgchlas = mean(meanO2Rate_umolmgchlas), 
            sdOxyEvo_umolO2mgchlas = sd(meanO2Rate_umolmgchlas),
            seOxyEvo_umolO2mgchlas = sd(meanO2Rate_umolmgchlas)/n()^(1/2)) %>%  

  ungroup() 
```


```{r}
GreenOxyEvobiomassMean <- OxyEvobiomassMean  %>%
  filter(WL == "530") %>%
  filter(Ex_WL == "535") %>% 
  filter(ActinicRate != "160" &
         ActinicRate != "320") %>% 
  mutate(WL2=case_when(WL=="530"~"MIX:530_660")) %>% 
  select(-c(WL)) %>% 
  rename(WL = WL2)


RedOxyEvobiomassMean <- OxyEvobiomassMean  %>%
  filter(WL == "660") %>%
  filter(Ex_WL == "590") %>% 
  filter(ActinicRate != "160" &
         ActinicRate != "320") %>% 
  mutate(WL2=case_when(WL=="660"~"MIX:530_660")) %>% 
  select(-c(WL)) %>% 
  rename(WL = WL2)


AllOxyEvobiomassMeanRG <-rbind(GreenOxyEvobiomassMean, RedOxyEvobiomassMean)

# AllOxyEvobiomassMean <- GreenOxyEvobiomassMean %>%
#  
#  full_join(., RedOxyEvobiomassMean, by = c("Strain" = "Strain", "WL" = "WL", "Ex_WL" = "Ex_WL", "Par_ue" = "Par_ue", "ActinicRate" = "ActinicRate", "CultureID" = "CultureID", "DATE" = "DATE", "Run" = "Run", "InnocDate" = "InnocDate", "ExpDate" = "ExpDate", "Photoperiod" = "Photoperiod", "Calculated_µmolPhotons_m-2d-1" = "Calculated_µmolPhotons_m-2d-1", "Tube" = "Tube", "O2" = "O2",  "LightShape" = "LightShape", "meanChl_ugmL" = "meanChl_ugmL", "sdChl_ugmL" = "sdChl_ugmL", "E_days" = "E_days", "meancellsml" = "meancellsml", "sdcellsml" = "sdcellsml", "meanChla_ugN" = "meanChla_ugN", "sdChla_ugN" = "sdChla_ugN", "filenameOptode" = "filenameOptode", "O2RateAll" = "O2RateAll", "meanO2RateSteps" = "meanO2RateSteps", "RunDateOptode" = "RunDateOptode", "LR_sLightAll" = "LR_sLightAll", "meanO2_umolL" = "meanO2_umolL", "seO2_umolL" = "seO2_umolL", "sdO2_umolL" = "sdO2_umolL", "Temp_c" = "Temp_c", "O2_Category" = "O2_Category", "ExpEndDate" = "ExpEndDate", "meanO2Rate_umolmLs" = "meanO2Rate_umolmLs", "meanO2Rate_umolcells" = "meanO2Rate_umolcells", "meanO2Rate_umolugchlas" = "meanO2Rate_umolugchlas", "meanO2Rate_umolmgchlas" = "meanO2Rate_umolmgchlas", "meanOxyEvo_umolO2mLs" = "meanOxyEvo_umolO2mLs", "sdOxyEvo_umolO2mLs" = "sdOxyEvo_umolO2mLs", "meanOxyEvo_umolO2cells" = "meanOxyEvo_umolO2cells", "sdOxyEvo_umolO2cells" = "sdOxyEvo_umolO2cells", "meanOxyEvo_umolO2mgchlas" = "meanOxyEvo_umolO2mgchlas", "sdOxyEvo_umolO2mgchlas" = "sdOxyEvo_umolO2mgchlas")) 

```



Growth rate-oxygen correlation mean
```{r}
GrowthOxygenCorr320 <- OxyEvobiomassMean  %>%
  filter(ActinicRate == "320") %>% 
  summarize(Strain, WL, Ex_WL, Par_ue, ActinicRate, CultureID, DATE, Run, InnocDate, ExpDate, Photoperiod, Tube, O2, LightShape, meanChl_ugmL, sdChl_ugmL, E_days, meancellsml, sdcellsml, meanChla_ugN, sdChla_ugN, filenameOptode, O2RateAll, meanO2RateSteps, RunDateOptode, LR_sLightAll, meanO2_umolL, seO2_umolL, sdO2_umolL, Temp_c, O2_Category, ExpEndDate, meanO2Rate_umolmLs, meanO2Rate_umolcells,  meanO2Rate_umolugchlas, meanO2Rate_umolmgchlas, meanOxyEvo_umolO2mLs, sdOxyEvo_umolO2mLs, seOxyEvo_umolO2mLs, meanOxyEvo_umolO2cells, sdOxyEvo_umolO2cells, seOxyEvo_umolO2cells, meanOxyEvo_umolO2mgchlas, sdOxyEvo_umolO2mgchlas, seOxyEvo_umolO2mgchlas) 
  
  
GrowthOxygenCorr60 <- OxyEvobiomassMean  %>%
  filter(ActinicRate == "40" | ActinicRate == "80")

GrowthOxygenCorr60 <- GrowthOxygenCorr60  %>%
group_by(Strain, WL, Ex_WL, Par_ue) %>% 


summarize(Strain, WL, Ex_WL, Par_ue, ActinicRate, CultureID, DATE, Run, InnocDate, ExpDate, Photoperiod, Tube, O2, LightShape, meanChl_ugmL, sdChl_ugmL, E_days, meancellsml, sdcellsml, meanChla_ugN, sdChla_ugN, filenameOptode, O2RateAll, meanO2RateSteps, RunDateOptode, LR_sLightAll, meanO2_umolL, seO2_umolL, sdO2_umolL, Temp_c, O2_Category, ExpEndDate, meanO2Rate_umolmLs, meanO2Rate_umolcells,  meanO2Rate_umolugchlas, meanO2Rate_umolmgchlas, meanOxyEvo_umolO2mLs, sdOxyEvo_umolO2mLs, seOxyEvo_umolO2mLs, meanOxyEvo_umolO2cells, sdOxyEvo_umolO2cells, seOxyEvo_umolO2cells, meanOxyEvo_umolO2mgchlas, sdOxyEvo_umolO2mgchlas, seOxyEvo_umolO2mgchlas, 
        ActinicRate = mean(ActinicRate), 
        meanOxyEvo_umolO2mgchlas = mean(meanOxyEvo_umolO2mgchlas)) %>% 
  ungroup()
                

GrowthOxygenCorr60_320 <- rbind(GrowthOxygenCorr60,GrowthOxygenCorr320)

```


```{r}
MultiCultiDataClean60_320 <- MultiCultiDataClean %>% 
  filter(Strain == "BA127R" | Strain == "BA77G") %>% 
  filter(Par_ue == 60 | Par_ue == 300) %>% 
  filter(Run != "56") %>% 
  filter(Run != "59") 
```

```{r}
GrowthOxygenCorrAll <- MultiCultiDataClean60_320 %>% 
  full_join(., GrowthOxygenCorr60_320, by = c("Strain" = "Strain", "Par_ue" = "Par_ue", "WL" = "WL")) %>% 
unique()


```


60-> mean 40 and 80/ 300-> 320
530 -> 535/ 660 -> 590
```{r}
GrowthOxygenCorrfilt320 <- GrowthOxygenCorrAll %>%
  filter(WL != "WW") %>%
  filter(ActinicRate == "320") %>% 
  filter(Par_ue == 300)

GrowthOxygenCorrfilt60 <- GrowthOxygenCorrAll %>%
  filter(WL != "WW") %>%
  filter(ActinicRate == "60") %>% 
  filter(Par_ue == 60)

GrowthOxygenCorrfilt60300 <- rbind(GrowthOxygenCorrfilt320, GrowthOxygenCorrfilt60)  

```


```{r}
GrowthOxygenCorrfilt60300530 <- GrowthOxygenCorrfilt60300 %>% 
  filter(WL == "530") %>%
  filter(Ex_WL == "535")

GrowthOxygenCorrfilt60300660 <- GrowthOxygenCorrfilt60300 %>% 
  filter(WL == "660") %>% 
  filter(Ex_WL == "590")
  
GrowthOxygenCorrfilt60300_530660 <- rbind(GrowthOxygenCorrfilt60300530, GrowthOxygenCorrfilt60300660) 
  
```


```{r}
MIX <- rbind(AllOxyEvobiomassMeanRG, OxyEvobiomassMean)

```

60 ue
```{r}
JP_127R_530_535 <- OxyEvobiomassMean  %>%
  filter(Strain == "BA127R") %>%
  filter(Par_ue == "60") %>%
  filter(WL == "530") %>%
  filter(Ex_WL == "535")
JP_127R_530_535 <- JP_127R_530_535  %>%
#P = Pm·tanh(α·E/Pm)+Rd
mutate(JP_fit = (309.051)*tanh((4.9521)*ActinicRate/(309.051))+(-123.02))

JP_127R_530_590 <- OxyEvobiomassMean  %>%
  filter(Strain == "BA127R") %>%
  filter(Par_ue == "60") %>%
  filter(WL == "530") %>%
  filter(Ex_WL == "590")
JP_127R_530_590 <- JP_127R_530_590  %>%
mutate(JP_fit = (306.607)*tanh((3.29504)*ActinicRate/(306.607))+(-127.73))

JP_127R_660_535 <- OxyEvobiomassMean  %>%
  filter(Strain == "BA127R") %>%
  filter(Par_ue == "60") %>%
  filter(WL == "660") %>%
  filter(Ex_WL == "535")
JP_127R_660_535 <- JP_127R_660_535  %>%
mutate(JP_fit = (312.599)*tanh((7.20919)*ActinicRate/(312.599))+(-97.298))

JP_127R_660_590 <- OxyEvobiomassMean  %>%
  filter(Strain == "BA127R") %>%
  filter(Par_ue == "60") %>%
  filter(WL == "660") %>%
  filter(Ex_WL == "590")
JP_127R_660_590 <- JP_127R_660_590  %>%
mutate(JP_fit = (315.453)*tanh((5.84096)*ActinicRate/(315.453))+(-113.9))

JP_77G_530_535 <- OxyEvobiomassMean  %>%
  filter(Strain == "BA77G") %>%
  filter(Par_ue == "60") %>%
  filter(WL == "530") %>%
  filter(Ex_WL == "535")
JP_77G_530_535 <- JP_77G_530_535  %>%
mutate(JP_fit = (208.417)*tanh((2.30103)*ActinicRate/(208.417))+(-67.395))

JP_77G_530_590 <- OxyEvobiomassMean  %>%
  filter(Strain == "BA77G") %>%
  filter(Par_ue == "60") %>%
  filter(WL == "530") %>%
  filter(Ex_WL == "590")
JP_77G_530_590 <- JP_77G_530_590  %>%
mutate(JP_fit = (196.652)*tanh((4.73441)*ActinicRate/(196.652))+(-86.527))

JP_77G_660_535 <- OxyEvobiomassMean  %>%
  filter(Strain == "BA77G") %>%
  filter(Par_ue == "60") %>%
  filter(WL == "660") %>%
  filter(Ex_WL == "535")
JP_77G_660_535 <- JP_77G_660_535  %>%
mutate(JP_fit = (370.733)*tanh((1.58599)*ActinicRate/(370.733))+(-101.78))

JP_77G_660_590 <- OxyEvobiomassMean  %>%
  filter(Strain == "BA77G") %>%
  filter(Par_ue == "60") %>%
  filter(WL == "660") %>%
  filter(Ex_WL == "590")
JP_77G_660_590 <- JP_77G_660_590  %>%
mutate(JP_fit = (291.181)*tanh((6.23645)*ActinicRate/(291.181))+(-100.64))
```


```{r}
JP_Meta <- rbind(JP_127R_530_535, JP_127R_530_590, JP_127R_660_535, JP_127R_660_590, JP_77G_530_535, JP_77G_530_590, JP_77G_660_535, JP_77G_660_590)

```




```{r}
MIX_JP <- MIX  %>%
  filter(Strain == "BA127R"|
          Strain == "BA77G") %>%
  filter(Par_ue == "60"|
          Par_ue == "300") %>%
  filter(Ex_WL == "535"|
        Ex_WL == "590") 

MIX_JP_All <- MIX_JP %>%
 full_join(., JP_Meta, by = c("Strain" = "Strain", "WL" = "WL", "Ex_WL" = "Ex_WL", "Par_ue" = "Par_ue", "ActinicRate" = "ActinicRate", "CultureID" = "CultureID", "DATE" = "DATE", "Run" = "Run", "InnocDate" = "InnocDate", "ExpDate" = "ExpDate", "Photoperiod" = "Photoperiod", "Calculated_µmolPhotons_m-2d-1" = "Calculated_µmolPhotons_m-2d-1", "Tube" = "Tube", "O2" = "O2",  "LightShape" = "LightShape", "meanChl_ugmL" = "meanChl_ugmL", "sdChl_ugmL" = "sdChl_ugmL", "E_days" = "E_days", "meancellsml" = "meancellsml", "sdcellsml" = "sdcellsml", "meanChla_ugN" = "meanChla_ugN", "sdChla_ugN" = "sdChla_ugN", "filenameOptode" = "filenameOptode", "O2RateAll" = "O2RateAll", "meanO2RateSteps" = "meanO2RateSteps", "RunDateOptode" = "RunDateOptode", "LR_sLightAll" = "LR_sLightAll", "meanO2_umolL" = "meanO2_umolL", "seO2_umolL" = "seO2_umolL", "sdO2_umolL" = "sdO2_umolL", "Temp_c" = "Temp_c", "O2_Category" = "O2_Category", "ExpEndDate" = "ExpEndDate", "meanO2Rate_umolmLs" = "meanO2Rate_umolmLs", "meanO2Rate_umolcells" = "meanO2Rate_umolcells", "meanO2Rate_umolugchlas" = "meanO2Rate_umolugchlas", "meanO2Rate_umolmgchlas" = "meanO2Rate_umolmgchlas", "meanOxyEvo_umolO2mLs" = "meanOxyEvo_umolO2mLs", "sdOxyEvo_umolO2mLs" = "sdOxyEvo_umolO2mLs", "seOxyEvo_umolO2mLs" = "seOxyEvo_umolO2mLs", "meanOxyEvo_umolO2cells" = "meanOxyEvo_umolO2cells", "sdOxyEvo_umolO2cells" = "sdOxyEvo_umolO2cells", "seOxyEvo_umolO2cells" = "seOxyEvo_umolO2cells", "meanOxyEvo_umolO2mgchlas" = "meanOxyEvo_umolO2mgchlas", "sdOxyEvo_umolO2mgchlas" = "sdOxyEvo_umolO2mgchlas", "seOxyEvo_umolO2mgchlas" = "seOxyEvo_umolO2mgchlas")) %>% 
unique()

```


Load Jassby Platt parameters Catalog - long
```{r load local Jassby Platt, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

JPCatalogLong <- read_sheet("https://docs.google.com/spreadsheets/d/1HKSPzzZii_hcgf2ZogvVX5-vCc3qs0Rk5pxvMcXkTi0/edit#gid=0") %>%

  drop_na(WL) %>%
  mutate(WL = unlist(WL))

```


```{r}
JPCatalogLongmean <- JPCatalogLong %>%
  
  mutate(Parameters_name = as.character(Parameters_name)) %>% 
  mutate(Parameters_value = as.numeric(Parameters_value)) %>% 

  group_by(WL, Ex_WL, Par_ue, Strain, Parameters_name) %>%
  summarize(CultureID, Strain, Par_ue, WL, Ex_WL, Parameters_name, Parameters_value,
            
            meanParameters_value = mean(Parameters_value), 
            sdParameters_value = sd(Parameters_value),
            seParameters_value = sd(Parameters_value)/n()^(1/2)) 
```


# Save assembled spectra data set
```{r save Olis}

#saveRDS(PARvsPUR, file.path(DataOut, paste(Project, "PURSySlRedGreenCCA.Rds", sep = "_"), fsep = .Platform$file.sep))

```


# Comparison Multiculti Import data

# Add MultiCulti Data
MultiCulti Import
```{r}
Project <- "PICO"
DataIn <- file.path("..", "ImportedData", "MultiCultiImport", fsep = .Platform$file.sep)
FileEncode <- "UTF-8" 
Delimiter <- ","
HeaderRows <- 0
```

MultiCulti Import
Exported only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

MultiCulti Import run70
```{r warning = FALSE}
MultiCultiFile <- "../ImportedData/MultiCultiImport/PICO_TargetDataMetaFilter_RUN70.Rds"
MultiCultiFileName <- str_split(string = MultiCultiFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 
MultiCultiData <- readRDS(MultiCultiFile)  %>%
  ungroup()

MultiCultiData70 <- MultiCultiData %>% 
summarize(time, Filename, CDateTime, Tube, abs_time, ToD, Day, ExpDate, Actinic_par, OD680, OD720, Run, ID, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate) %>% 
mutate(Actinic_par = Actinic_par/1000) %>% 
mutate(timeRound = round(time, 0))

MultiCultiDataMean70 <- MultiCultiData70 %>% 
group_by(ID, timeRound) %>% 
summarize(time, Filename, CDateTime, Tube, abs_time, ToD, Day, ExpDate, Actinic_par, OD680, OD720, Run, ID, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, O2, WL, LightShape, ExpEndDate, timeRound, meanActinic_par = mean(Actinic_par), meanOD680 = mean(OD680), meanOD720 = mean(OD720)) %>%
ungroup()

MultiCultiDataMeanSmall70 <- MultiCultiDataMean70 %>%
  select(-c(time, abs_time, ToD, Actinic_par, OD680, OD720, CDateTime, InnocDate)) %>% 
  unique()

# #BA127R, BA48R
# MultiCultiDataMeanSmall39BA127R <- MultiCultiDataMeanSmall39 %>%
#   filter(Strain == "BA127R") 
# 
# MultiCultiDataMeanSmall39BA48R <- MultiCultiDataMeanSmall39 %>%
#   filter(Strain == "BA48R") 

```


```{r}
# library(extrafont)
# font_import()
# loadfonts(device="win")       #Register fonts for Windows bitmap output
# fonts()
```


Growth curve - run70
```{r fig.height = 6, fig.width = 8, warning = FALSE}

lab1=c(expression(OD[680]), expression(OD[720]))

Par_ue.labs <- c("Light level: 60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")

Strain.labs <- c("PE-rich", "PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

WL.labs <- c("Growth light: 530 nm", "Growth light: 660 nm", "Growth light: 530 nm", "Growth light: 660 nm")
names(WL.labs) <- c("530", "660", "530", "660")

data_text2 <- data.frame(
  Par_ue = c(60, 60, 300, 300, 60, 60, 300, 300),
  WL   = c("530", "660", "530", "660", "530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"),
  label = c('A', 'B', 'C', 'D', "E", "F", "G", "H"))

MultiCultiDataPlot <- MultiCultiDataMeanSmall70 %>% 
  #filter(timeRound <= 110) %>% 
  ggplot() +
  geom_area(aes(x = timeRound, y = meanActinic_par), size = 0.1, fill = "goldenrod", alpha = 0.6) +
  geom_line(aes(x = timeRound, y = meanOD680, colour = "seagreen4"), size = 0.75, show.legend = T) +
  geom_line(aes(x = timeRound, y = meanOD720, colour = "darkslategray"), size = 0.75, show.legend = T) +
  geom_text(data=data_text2, aes(x=250, y=0.92, label=label), size=5) +
  scale_colour_discrete(type=c("seagreen4", "darkslategray"), name="", labels = lab1) +
  scale_y_continuous(breaks=seq(0, 1, by = 0.25)) +
  coord_cartesian(ylim = c(0, 1)) +
  
  #scale_colour_manual(values = MCMIXColours) +
  #guides(colour = FALSE) +
  labs(y = "Optical density (OD)", x = "Elapsed time (h)") +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(WL = WL.labs, Strain = Strain.labs, Par_ue = Par_ue.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=14),
        axis.title = element_text(size=17),
        strip.background = element_rect(fill="pink3"),
        strip.background.y = element_rect(fill="white"),
        strip.text = element_text(size=13),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.06,0.94),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        # legend.key.height= unit(0.005, 'cm'),
        # legend.key.width= unit(0.005, 'cm'),
        # # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=12))
MultiCultiDataPlot





lab1=c(expression(OD[680]), expression(OD[720]))

Par_ue.labs <- c("Light level: 60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")

Strain.labs <- c("Strain: PE-rich", "Strain: PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

WL.labs <- c("Growth light: 530 nm", "Growth light: 660 nm", "Growth light: 530 nm", "Growth light: 660 nm")
names(WL.labs) <- c("530", "660", "530", "660")

data_text2 <- data.frame(
  Par_ue = c(60, 60, 300, 300, 60, 60, 300, 300),
  WL   = c("530", "660", "530", "660", "530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"),
  label = c('A', 'B', 'C', 'D', "E", "F", "G", "H"))

MultiCultiDataPlot <- MultiCultiDataMeanSmall70 %>% 
  #filter(timeRound <= 110) %>% 
  ggplot() +
  geom_area(aes(x = timeRound, y = meanActinic_par), size = 0.1, fill = "goldenrod", alpha = 0.6) +
  geom_line(aes(x = timeRound, y = meanOD680, colour = "seagreen4"), size = 0.75, show.legend = T) +
  geom_line(aes(x = timeRound, y = meanOD720, colour = "darkslategray"), size = 0.75, show.legend = T) +
  geom_text(data=data_text2, aes(x=250, y=0.92, label=label), size=5) +
  scale_colour_discrete(type=c("seagreen4", "darkslategray"), name="", labels = lab1) +
  scale_y_continuous(breaks=seq(0, 1, by = 0.25)) +
  coord_cartesian(ylim = c(0, 1)) +
  
  #scale_colour_manual(values = MCMIXColours) +
  #guides(colour = FALSE) +
  labs(y = "Optical density (OD)", x = "Elapsed time (h)") +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(WL = WL.labs, Strain = Strain.labs, Par_ue = Par_ue.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.background.y = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.06,0.94),
        #legend.key = element_rect(size = 0.1, fill = "transparent"),
        # legend.key.height= unit(0.005, 'cm'),
        # legend.key.width= unit(0.005, 'cm'),
        # # legend.text.align = 0,
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text = element_text(size=12))
MultiCultiDataPlot
```



per chla 60
Data Visualization
```{r fig.height = 5, fig.width = 8, warning = FALSE}

Par_ue.labs <- c("Light level: 60 µE", "300 µE")
names(Par_ue.labs) <- c("60", "300")
WL.labs <- c("Growth light: 530 nm", "Growth light: 660 nm")
names(WL.labs) <- c("530", "660")
Strain.labs <- c("PE-rich", "PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  Par_ue = c(60, 60),
  WL   = c("530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  label = c('A', 'B', 'C', 'D'))

data_hline1 <- data.frame(
  Par_ue = c(60, 60),
  WL   = c("530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  value = c(45, 138, 90, 168))

data_hline2 <- data.frame(
  Par_ue = c(60, 60),
  WL   = c("530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  value = c(100, 180, 50, -15))

prelimplot60 <- OxyEvobiomassMean  %>%
  filter(Strain == "BA127R"| Strain == "BA77G") %>%
  filter(Par_ue == "60") %>%
  filter(WL == "530"| WL == "660") %>%
  filter(Ex_WL == "535"| Ex_WL == "590") %>%
  ggplot() +
  geom_point(aes(x = ActinicRate, y = meanOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL), label = CultureID), size=3, alpha=0.9, show.legend = T) +
  geom_line(aes(x = ActinicRate, y = meanOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL), label = CultureID), linetype="dotted", size=0.7) +
  geom_errorbar(aes(x = ActinicRate, ymin = meanOxyEvo_umolO2mgchlas-seOxyEvo_umolO2mgchlas, ymax = meanOxyEvo_umolO2mgchlas+seOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL))) +
  geom_vline(aes(xintercept = Par_ue), linetype="dotted") +
  geom_hline(data = data_hline1, aes(yintercept = value), linetype="dotdash", colour = "darkorange") +
  geom_hline(data = data_hline2, aes(yintercept = value), linetype="dashed", colour = "yellowgreen") +
  scale_colour_manual(values = Colours_nm, labels = c("Ex535 nm", "Ex590 nm")) +
  geom_text(data=data_text2, aes(x=315, y=380, label=label), size=5) +
  #guides(colour = FALSE, linetype = FALSE) +
  labs(y = "Oxygen  evolution  [ µmol ( mg Chl "~italic(a)~")"~""^-1 ~s^-1~"]", x = "Light  level  ( µmol photons" ~m^-2 ~s^-1~")") +
  scale_x_continuous(breaks=seq(0, 320, by = 80)) +
  coord_cartesian(xlim = c (-1, 330)) +
  scale_y_continuous(breaks=seq(-200, 400, by = 100)) +
  coord_cartesian(ylim = c (-220, 420)) +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, Strain = Strain.labs, WL = WL.labs, Par_ue = Par_ue.labs)) +
  theme_bw() +
        theme(panel.grid.minor = element_blank(),
              panel.grid.major = element_blank(),
        axis.text = element_text(size=14),
        axis.text.x = element_blank(),
        axis.title = element_text(size=17),
        strip.background = element_rect(fill="pink3"),
        strip.background.y = element_rect(fill="white"),
        strip.text = element_text(size=13),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.position = c(0.09,0.94),
        legend.text = element_text(size=12))
prelimplot60



# Par_ue.labs <- c("Light level: 60 µE", "300 µE")
# names(Par_ue.labs) <- c("60", "300")
# WL.labs <- c("Growth light: 530 nm", "Growth light: 660 nm")
# names(WL.labs) <- c("530", "660")
# Strain.labs <- c("PE-rich", "PC-rich")
# names(Strain.labs) <- c("BA127R", "BA77G")
# 
# data_text2 <- data.frame(
#   Par_ue = c(60, 60),
#   WL   = c("530", "660", "530", "660"),
#   Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
#   label = c('A', 'B', 'C', 'D'))
# 
# data_hline1 <- data.frame(
#   Par_ue = c(60, 60),
#   WL   = c("530", "660", "530", "660"),
#   Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
#   value = c(45, 138, 90, 168))
# 
# data_hline2 <- data.frame(
#   Par_ue = c(60, 60),
#   WL   = c("530", "660", "530", "660"),
#   Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
#   value = c(100, 180, 50, -15))
# 
# prelimplot60 <- OxyEvobiomassMean  %>%
#   filter(Strain == "BA127R"| Strain == "BA77G") %>%
#   filter(Par_ue == "60") %>%
#   filter(WL == "530"| WL == "660") %>%
#   filter(Ex_WL == "535"| Ex_WL == "590") %>%
#   ggplot() +
#   geom_point(aes(x = ActinicRate, y = meanOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL), label = CultureID), size=3, alpha=0.9, show.legend = T) +
#   geom_line(aes(x = ActinicRate, y = meanOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL), label = CultureID), linetype="dotted", size=0.7) +
#   geom_errorbar(aes(x = ActinicRate, ymin = meanOxyEvo_umolO2mgchlas-seOxyEvo_umolO2mgchlas, ymax = meanOxyEvo_umolO2mgchlas+seOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL))) +
#   geom_vline(aes(xintercept = Par_ue), linetype="dotted") +
#   geom_hline(data = data_hline1, aes(yintercept = value), linetype="dotdash", colour = "darkorange") +
#   geom_hline(data = data_hline2, aes(yintercept = value), linetype="dashed", colour = "yellowgreen") +
#   scale_colour_manual(values = Colours_nm, labels = c("Ex535 nm", "Ex590 nm")) +
#   geom_text(data=data_text2, aes(x=315, y=380, label=label), size=6, family="Candara") +
#   #guides(colour = FALSE, linetype = FALSE) +
#   labs(y = "Oxygen  evolution  [ µmol ( mg Chl "~italic(a)~")"~""^-1 ~s^-1~"]", x = "Light  level  ( µmol photons" ~m^-2 ~s^-1~")") +
#   scale_x_continuous(breaks=seq(0, 320, by = 80)) +
#   coord_cartesian(xlim = c (-1, 330)) +
#   scale_y_continuous(breaks=seq(-200, 400, by = 100)) +
#   coord_cartesian(ylim = c (-220, 420)) +
#   ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, Strain = Strain.labs, WL = WL.labs, Par_ue = Par_ue.labs)) +
#   theme_bw() +
#         theme(panel.grid.minor = element_blank(),
#               panel.grid.major = element_blank(),
#         axis.text = element_text(size=16),
#         axis.title = element_text(size=17.5),
#         strip.background = element_rect(fill="pink3"),
#         strip.background.y = element_rect(fill="white"),
#         strip.text = element_text(size=13),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(r=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.title = element_blank(),
#         legend.position = c(0.08,0.94),
#         legend.text = element_text(size=12),
#         text=element_text(family="Candara"))
# prelimplot60


```

per chla
Data Visualization 300
```{r fig.height = 6.5, fig.width = 8, warning = FALSE}

Par_ue.labs <- c("60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")
WL.labs <- c("Growth light: 530 nm", "Growth light: 660 nm")
names(WL.labs) <- c("530", "660")
Strain.labs <- c("PE-rich", "PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  Par_ue = c(300, 300),
  WL   = c("530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  label = c("E", "F", "G", "H"))

data_hline1 <- data.frame(
  Par_ue = c(300, 300),
  WL   = c("530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  value = c(175, 140, 180, 209))

data_hline2 <- data.frame(
  Par_ue = c(300, 300),
  WL   = c("530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  value = c(225, 160, 205, 260))

prelimplot300 <- OxyEvobiomassMean  %>%
  filter(Strain == "BA127R"| Strain == "BA77G") %>%
  filter(Par_ue == "300") %>%
  filter(WL == "530"| WL == "660") %>%
  filter(Ex_WL == "535"| Ex_WL == "590") %>%
  ggplot() +
  geom_point(aes(x = ActinicRate, y = meanOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL), label = CultureID), size=3, alpha=0.9, show.legend = F) +
  geom_line(aes(x = ActinicRate, y = meanOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL), label = CultureID), linetype="dotted", size=0.7) +
  geom_errorbar(aes(x = ActinicRate, ymin = meanOxyEvo_umolO2mgchlas-seOxyEvo_umolO2mgchlas, ymax = meanOxyEvo_umolO2mgchlas+seOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL))) +
  geom_vline(aes(xintercept = Par_ue), linetype="dotted") +
  geom_hline(data = data_hline1, aes(yintercept = value), linetype="dotdash", colour = "darkorange") +
  geom_hline(data = data_hline2, aes(yintercept = value), linetype="dashed", colour = "yellowgreen") +
  scale_colour_manual(values = Colours_nm, labels = c("Ex535 nm", "Ex590 nm")) +
  geom_text(data=data_text2, aes(x=315, y=380, label=label), size=5) +
  guides(colour = FALSE, linetype = FALSE) +
  labs(y = "Oxygen  evolution  [ µmol ( mg Chl "~italic(a)~")"~""^-1 ~s^-1~"]", x = "Light  level  ( µmol photons" ~m^-2 ~s^-1~")") +
  scale_x_continuous(breaks=seq(0, 320, by = 80)) +
  coord_cartesian(xlim = c (-1, 330)) +
  scale_y_continuous(breaks=seq(-200, 400, by = 100)) +
  coord_cartesian(ylim = c (-220, 420)) +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, Strain = Strain.labs, WL = WL.labs, Par_ue = Par_ue.labs)) +
  theme_bw() +
        theme(panel.grid.minor = element_blank(),
              panel.grid.major = element_blank(),
        axis.text = element_text(size=14),
        axis.title = element_text(size=17),
        strip.background = element_rect(fill="pink3"),
        strip.background.y = element_rect(fill="white"),
        strip.text = element_text(size=13),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.position = c(0.08,0.94),
        legend.text = element_text(size=12))
prelimplot300


```
LRC per ch combine
```{r fig.height = 11, fig.width = 8, warning = FALSE}
ggarrange(prelimplot60, prelimplot300,
          ncol = 1, nrow = 2)

```


per chla
Data Visualization
```{r fig.height = 6, fig.width = 8, warning = FALSE}


#"yellowgreen"  "darkorange"
#mean umolO2/chla/s 60 and 300 uE
Par_ue.labs <- c("Light level: 60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")
WL.labs <- c("Growth light: 530 nm", "Growth light: 660 nm")
names(WL.labs) <- c("530", "660")
Strain.labs <- c("Strain: PE-rich", "Strain: PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  Par_ue = c(60, 60, 300, 300, 60, 60, 300, 300),
  WL   = c("530", "660", "530", "660", "530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"),
  label = c('A', 'B', 'C', 'D', "E", "F", "G", "H"))

data_hline1 <- data.frame(
  Par_ue = c(60, 60, 300, 300, 60, 60, 300, 300),
  WL   = c("530", "660", "530", "660", "530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"),
  value = c(45, 138, 175, 140, 90, 168, 180, 209))

data_hline2 <- data.frame(
  Par_ue = c(60, 60, 300, 300, 60, 60, 300, 300),
  WL   = c("530", "660", "530", "660", "530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"),
  value = c(100, 180, 225, 160, 50, -15, 205, 260))

# 
# data_hline2 <- data.frame(
#   Par_ue = c(60, 60, 300, 300, 60, 60, 300, 300),
#   WL   = c("530", "660", "530", "660", "530", "660", "530", "660"),
#   Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"),
#   value = c(35, 138, 175, 140, 60, -5, 180, 209, 
#             100, 180, 225, 160, 100, 158, 190, 260))

prelimplot3 <- OxyEvobiomassMean  %>%
  filter(Strain == "BA127R"| Strain == "BA77G") %>%
  filter(Par_ue == "60"| Par_ue == "300") %>%
  filter(WL == "530"| WL == "660") %>%
  filter(Ex_WL == "535"| Ex_WL == "590") %>%
  ggplot() +
  geom_point(aes(x = ActinicRate, y = meanOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL), label = CultureID), size=3, alpha=0.9, show.legend = T) +
  geom_line(aes(x = ActinicRate, y = meanOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL), label = CultureID), linetype="dotted", size=0.5) +
  geom_errorbar(aes(x = ActinicRate, ymin = meanOxyEvo_umolO2mgchlas-seOxyEvo_umolO2mgchlas, ymax = meanOxyEvo_umolO2mgchlas+seOxyEvo_umolO2mgchlas, colour = as.factor(Ex_WL))) +
  # geom_hline(yintercept = 90, linetype = "solid", inherit.aes = FALSE, data = . %>% filter(Par_ue = 300)) +

  geom_vline(aes(xintercept = Par_ue), linetype="dotted") +
  geom_hline(data = data_hline1, aes(yintercept = value), linetype="dotdash", colour = "darkorange") +
  geom_hline(data = data_hline2, aes(yintercept = value), linetype="dashed", colour = "yellowgreen") +

  scale_colour_manual(values = Colours_nm, labels = c("Ex535 nm", "Ex590 nm")) +
  geom_text(data=data_text2, aes(x=315, y=400, label=label), size=5) +
  #guides(colour = FALSE, linetype = FALSE) +
  labs(y = "Oxygen  evolution  [ µmol ( mg Chl  "~italic(a)~")"~""^-1 ~s^-1~"]", x = "Light  level  ( µmol photons" ~m^-2 ~s^-1~")") +
  scale_x_continuous(breaks=seq(0, 320, by = 80)) +
  coord_cartesian(xlim = c (-1, 330)) +
  scale_y_continuous(breaks=seq(-200, 400, by = 100)) +
  coord_cartesian(ylim = c (-220, 420)) +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, Strain = Strain.labs, WL = WL.labs, Par_ue = Par_ue.labs)) +
  theme_bw() +
        theme(panel.grid.minor = element_blank(),
              panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.position = c(0.08,0.94),
        legend.text = element_text(size=12))
prelimplot3
```



Parameters
```{r fig.height = 5, fig.width = 8}
Par_ue.labs <- c("Light level: 60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")
WL.labs <- c("Growth light: 530 nm", "Growth light: 660 nm")
names(WL.labs) <- c("530", "660")
Strain.labs <- c("PE-rich", "PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  Par_ue = c(60, 60, 300, 300, 60, 60, 300, 300),
  WL   = c("530", "660", "530", "660", "530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"),
  label = c('A', 'B', 'C', 'D', "E", "F", "G", "H"))

data_text4 <- data.frame(WL = c("530"),Strain = c("BA127R"), Par_ue = c(60), label = c('a'))
data_text5 <- data.frame(WL = c("660"),Strain = c("BA127R"), Par_ue = c(60), label = c('a'))
data_text6 <- data.frame(WL = c("530"),Strain = c("BA127R"), Par_ue = c(300), label = c('a'))
data_text7 <- data.frame(WL = c("660"),Strain = c("BA127R"), Par_ue = c(300), label = c('a'))

data_text8 <- data.frame(WL = c("530"),Strain = c("BA77G"), Par_ue = c(60), label = c('d'))
data_text9 <- data.frame(WL = c("660"),Strain = c("BA77G"), Par_ue = c(60), label = c('c'))
data_text10 <- data.frame(WL = c("530"),Strain = c("BA77G"), Par_ue = c(300), label = c('b'))
#data_text11 <- data.frame(WL = c("660"),Strain = c("BA77G"), Par_ue = c(300), label = c('a'))

data_text12 <- data.frame(WL = c("530"),Strain = c("BA127R"), Par_ue = c(60), label = c('a'))
data_text13 <- data.frame(WL = c("660"),Strain = c("BA127R"), Par_ue = c(60), label = c('a'))
data_text14 <- data.frame(WL = c("530"),Strain = c("BA127R"), Par_ue = c(300), label = c('a'))
data_text15 <- data.frame(WL = c("660"),Strain = c("BA127R"), Par_ue = c(300), label = c('a'))

data_text16 <- data.frame(WL = c("530"),Strain = c("BA77G"), Par_ue = c(60), label = c('d'))
data_text17 <- data.frame(WL = c("660"),Strain = c("BA77G"), Par_ue = c(60), label = c('c'))
data_text18 <- data.frame(WL = c("530"),Strain = c("BA77G"), Par_ue = c(300), label = c('a'))
#data_text19 <- data.frame(WL = c("660"),Strain = c("BA77G"), Par_ue = c(300), label = c('a'))



JPCatalogLongmeanPlotpm <- JPCatalogLongmean  %>%
  mutate(Par_ue = as.numeric(Par_ue)) %>% 
  filter(Parameters_name == "Pm") %>% 
  ggplot() +

  geom_point(aes(x = Ex_WL, y = meanParameters_value, label = CultureID), size=4, alpha=0.7, color = '#3C3B53') +
  geom_errorbar(aes(x = Ex_WL, ymin = meanParameters_value-sdParameters_value, ymax = meanParameters_value+sdParameters_value), width=0.4, color = '#3C3B53') +
  geom_text(data=data_text2, aes(x=2.3, y=480, label=label), size=5) +
  
    geom_text(data=data_text4, aes(x=1, y=250, label=label), size=4) +
    geom_text(data=data_text5, aes(x=1, y=270, label=label), size=4) +
    geom_text(data=data_text6, aes(x=1, y=250, label=label), size=4) +
    geom_text(data=data_text7, aes(x=1, y=200, label=label), size=4) +
  
    geom_text(data=data_text8, aes(x=1, y=160, label=label), size=4) +
    geom_text(data=data_text9, aes(x=1, y=260, label=label), size=4) +
    geom_text(data=data_text10, aes(x=1, y=270, label=label), size=4) +
    #geom_text(data=data_text11, aes(x=1, y=190, label=label), size=4) +
    geom_text(data=data_text12, aes(x=2, y=200, label=label), size=4) +
    geom_text(data=data_text13, aes(x=2, y=280, label=label), size=4) +
    geom_text(data=data_text14, aes(x=2, y=380, label=label), size=4) +
    geom_text(data=data_text15, aes(x=2, y=300, label=label), size=4) +
  
    geom_text(data=data_text16, aes(x=2, y=160, label=label), size=4) +
    geom_text(data=data_text17, aes(x=2, y=260, label=label), size=4) +
    geom_text(data=data_text18, aes(x=2, y=300, label=label), size=4) +
    #geom_text(data=data_text19, aes(x=2, y=40, label=label), size=4) +



  #scale_colour_manual(values = Colours_nm) +
  labs(y = "Pm", x = "Measured wavelength (nm)") +
  scale_y_continuous(breaks=seq(0, 500, by = 100)) +
  coord_cartesian(ylim = c (0, 500)) +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, Strain = Strain.labs, WL = WL.labs, Par_ue = Par_ue.labs)) +
  theme_bw() + 
   theme(panel.grid.minor = element_blank(),
         panel.grid.major = element_blank(),
        axis.text = element_text(size=14),
        axis.text.x = element_blank(),
        axis.title = element_text(size=17),
        strip.background = element_rect(fill="pink3"),
        strip.background.y = element_rect(fill="white"),
        strip.text = element_text(size=13),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_blank(),
        legend.background = element_blank(),
        legend.text = element_blank(),
        legend.title = element_blank(),
        legend.key = element_blank())
JPCatalogLongmeanPlotpm


```

alpha
```{r fig.height = 5, fig.width = 8}


Par_ue.labs <- c("Light level: 60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")
WL.labs <- c("Growth light: 530 nm", "Growth light: 660 nm")
names(WL.labs) <- c("530", "660")
Strain.labs <- c("PE-rich", "PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  Par_ue = c(60, 60, 300, 300, 60, 60, 300, 300),
  WL   = c("530", "660", "530", "660", "530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"),
  label = c('A', 'B', 'C', 'D', "E", "F", "G", "H"))

data_text5 <- data.frame(WL = c("530"),Strain = c("BA127R"), Par_ue = c(60), label = c('ab'))
data_text6 <- data.frame(WL = c("660"),Strain = c("BA127R"), Par_ue = c(60), label = c('a'))
data_text7 <- data.frame(WL = c("530"),Strain = c("BA127R"), Par_ue = c(300), label = c('bc'))
data_text8 <- data.frame(WL = c("660"),Strain = c("BA127R"), Par_ue = c(300), label = c('b'))

data_text9 <- data.frame(WL = c("530"),Strain = c("BA77G"), Par_ue = c(60), label = c('b'))
data_text10 <- data.frame(WL = c("660"),Strain = c("BA77G"), Par_ue = c(60), label = c('b'))
data_text11 <- data.frame(WL = c("530"),Strain = c("BA77G"), Par_ue = c(300), label = c('b'))
data_text12 <- data.frame(WL = c("660"),Strain = c("BA77G"), Par_ue = c(300), label = c('b'))

data_text13 <- data.frame(WL = c("530"),Strain = c("BA127R"), Par_ue = c(60), label = c('b'))
data_text14 <- data.frame(WL = c("660"),Strain = c("BA127R"), Par_ue = c(60), label = c('a'))
data_text15 <- data.frame(WL = c("530"),Strain = c("BA127R"), Par_ue = c(300), label = c('abc'))
data_text16 <- data.frame(WL = c("660"),Strain = c("BA127R"), Par_ue = c(300), label = c('c'))

data_text17 <- data.frame(WL = c("530"),Strain = c("BA77G"), Par_ue = c(60), label = c('ab'))
data_text18 <- data.frame(WL = c("660"),Strain = c("BA77G"), Par_ue = c(60), label = c('ab'))
data_text19 <- data.frame(WL = c("530"),Strain = c("BA77G"), Par_ue = c(300), label = c('a'))
#data_text20 <- data.frame(WL = c("660"),Strain = c("BA77G"), Par_ue = c(300), label = c('b'))


JPCatalogLongmeanPlotalpha <- JPCatalogLongmean  %>%
  mutate(Par_ue= as.numeric(Par_ue)) %>% 
  filter(Parameters_name == "Alpha") %>% 
  ggplot() +

  geom_point(aes(x = Ex_WL, y = meanParameters_value, label = CultureID), size=4, alpha=0.7, color = '#3C3B53') +
  geom_errorbar(aes(x = Ex_WL, ymin = meanParameters_value-sdParameters_value, ymax = meanParameters_value+sdParameters_value), width=0.4, color = '#3C3B53') +
    geom_text(data=data_text2, aes(x=2.3, y=9, label=label), size=5) +
  
    geom_text(data=data_text5, aes(x=1, y=2.5, label=label), size=4) +
    geom_text(data=data_text6, aes(x=1, y=5.5, label=label), size=4) +
    geom_text(data=data_text7, aes(x=1, y=0.4, label=label), size=4) +
    geom_text(data=data_text8, aes(x=1, y=1.5, label=label), size=4) +
  
    geom_text(data=data_text9, aes(x=1, y=0.9, label=label), size=4) +
    geom_text(data=data_text10, aes(x=1, y=0.9, label=label), size=4) +
    geom_text(data=data_text11, aes(x=1, y=0.4, label=label), size=4) +
    geom_text(data=data_text12, aes(x=1, y=0.4, label=label), size=4) +
  
    geom_text(data=data_text13, aes(x=2, y=2.2, label=label), size=4) +
    geom_text(data=data_text14, aes(x=2, y=5, label=label), size=4) +
    geom_text(data=data_text15, aes(x=2, y=6, label=label), size=4) +
    geom_text(data=data_text16, aes(x=2, y=0.2, label=label), size=4) +
  
    geom_text(data=data_text17, aes(x=2, y=2.7, label=label), size=4) +
    geom_text(data=data_text18, aes(x=2, y=5.1, label=label), size=4) +
    geom_text(data=data_text19, aes(x=2, y=5, label=label), size=4) +
    #geom_text(data=data_text20, aes(x=2, y=5, label=label), size=4) +

  #scale_colour_manual(values = Colours_nm) +
  labs(y = "Alpha", x = "Measured wavelength (nm)") +
  scale_y_continuous(breaks=seq(0, 10, by = 2.5)) +
  coord_cartesian(ylim = c (0, 10)) +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, Strain = Strain.labs, WL = WL.labs, Par_ue = Par_ue.labs)) +
  theme_bw() + 
   theme(panel.grid.minor = element_blank(),
         panel.grid.major = element_blank(),
        axis.text = element_text(size=14),
        axis.title = element_text(size=17),
        strip.background = element_rect(fill="pink3"),
        strip.background.y = element_rect(fill="white"),
        strip.text = element_text(size=13),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_blank(),
        legend.text = element_blank(),
        legend.title = element_blank(),
        legend.key = element_blank())
JPCatalogLongmeanPlotalpha


```


```{r fig.height = 9, fig.width = 8, warning = FALSE}
ggarrange(JPCatalogLongmeanPlotpm, JPCatalogLongmeanPlotalpha,
          ncol = 1, nrow = 2)

```



Manuscript plot - growth -> delta
```{r fig.height = 5, fig.width = 8, warning = FALSE}


#Delta_2
Photoperiod.labs <- c("Chlorophyll proxy of OD680-OD720")
names(Photoperiod.labs) <- c("12")
Par_ue.labs <- c("Light level: 60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")
Strain.labs <- c("PE-rich", "PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  Photoperiod = c(12, 12),
  WL   = c("530", "660"),
  Par_ue = c(60, 300),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  label = c('A', 'B', 'C', 'D'))
data_text24 <- data.frame(Strain = c('BA127R'), Par_ue = c(60), Photoperiod = c(12), label = c('b'))
data_text25 <- data.frame(Strain = c('BA127R'), Par_ue = c(60), Photoperiod = c(12), label = c('c'))
data_text26 <- data.frame(Strain = c('BA127R'), Par_ue = c(300), Photoperiod = c(12), label = c('a'))
data_text27 <- data.frame(Strain = c('BA127R'), Par_ue = c(300), Photoperiod = c(12), label = c('b'))

data_text32 <- data.frame(Strain = c('BA77G'), Par_ue = c(60), Photoperiod = c(12), label = c('f'))
data_text33 <- data.frame(Strain = c('BA77G'), Par_ue = c(60), Photoperiod = c(12), label = c('e'))
data_text34 <- data.frame(Strain = c('BA77G'), Par_ue = c(300), Photoperiod = c(12), label = c('e'))
data_text35 <- data.frame(Strain = c('BA77G'), Par_ue = c(300), Photoperiod = c(12), label = c('d'))

deltaOD_LmuSummaryGrowthPlotdelta <- MultiCultiDataClean %>%
  filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  filter(Strain == "BA127R" | Strain == "BA77G") %>%
  filter(Photoperiod == "12") %>%
  filter(WL != "WW") %>%
  filter(WL != "450") %>%
  filter(WL != "620") %>%
  filter(Par_ue != "180") %>%
  filter(Par_ue == "60"| Par_ue == "300") %>%
  filter(Run != "56") %>%
  filter(Run != "59") %>%
  ggplot() +
  #geom_point(aes(x = WL, y = OD720_Lmu_corr, colour = "OD 720"), size = 4, alpha = 0.9) +
  geom_point(aes(x = WL, y = deltaOD_Lmu_corr, colour = "#3C3B53"), size = 4, alpha = 0.8, show.legend = F) +
    geom_text(data=data_text2, aes(x=2.4, y=0.065, label=label), size=5) +
    geom_text(data=data_text24, aes(x=1, y=0.011, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text25, aes(x=2, y=0.003, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text26, aes(x=1, y=0.040, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text27, aes(x=2, y=0.014, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text32, aes(x=1, y=0.002, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text33, aes(x=2, y=0.013, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text34, aes(x=1, y=0.010, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text35, aes(x=2, y=0.029, label=label), size=4, color = '#3C3B53') +
labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Growth light (nm)") +
   #geom_errorbar(aes(x = WL, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=0.3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
   geom_errorbar(aes(x = WL, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), size = 0.3, width=0.3, color = '#3C3B53', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
  scale_y_continuous(breaks=seq(0, 0.06, by = 0.02)) +
  coord_cartesian(ylim = c (0, 0.075)) +
  scale_colour_discrete(type=c("#3C3B53", "#3C3B53"), name="") +
 ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, Photoperiod), labeller = labeller(WL = label_both, Strain = Strain.labs, Par_ue = Par_ue.labs, Photoperiod = Photoperiod.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=14),
        axis.text.x = element_blank(),
        axis.title = element_text(size=17),
        strip.background = element_rect(fill="pink3"),
        strip.background.y = element_rect(fill="white"),
        strip.text = element_text(size=13),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.08,0.94),
        legend.text = element_text(size=12))
deltaOD_LmuSummaryGrowthPlotdelta


```

Manuscript plot - growth -> x-WL different letter statistic
```{r fig.height = 6.5, fig.width = 8, warning = FALSE}

Photoperiod.labs <- c("Cell-scatter proxy OD720")
names(Photoperiod.labs) <- c("12")
Par_ue.labs <- c("Light level: 60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")
Strain.labs <- c("PE-rich", "PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  Photoperiod = c(12, 12),
  WL   = c("530", "660"),
  Par_ue = c(60, 300),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  label = c('E', 'F', 'G', 'H'))
data_text24 <- data.frame(Strain = c('BA127R'), Par_ue = c(60),Photoperiod = c(12), label = c('b'))
data_text25 <- data.frame(Strain = c('BA127R'), Par_ue = c(60),Photoperiod = c(12), label = c('c'))
data_text26 <- data.frame(Strain = c('BA127R'), Par_ue = c(300),Photoperiod = c(12), label = c('a'))
data_text27 <- data.frame(Strain = c('BA127R'), Par_ue = c(300),Photoperiod = c(12), label = c('ab'))

data_text32 <- data.frame(Strain = c('BA77G'), Par_ue = c(60),Photoperiod = c(12), label = c('f'))
data_text33 <- data.frame(Strain = c('BA77G'), Par_ue = c(60),Photoperiod = c(12), label = c('e'))
data_text34 <- data.frame(Strain = c('BA77G'), Par_ue = c(300),Photoperiod = c(12), label = c('e'))
data_text35 <- data.frame(Strain = c('BA77G'), Par_ue = c(300),Photoperiod = c(12), label = c('d'))

deltaOD_LmuSummaryGrowthPlot720 <- MultiCultiDataClean %>%
  filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  filter(Strain == "BA127R" | Strain == "BA77G") %>%
  filter(Photoperiod == "12") %>%
  filter(WL != "WW") %>%
  filter(WL != "450") %>%
  filter(WL != "620") %>%
  filter(Par_ue != "180") %>%
  filter(Par_ue == "60"| Par_ue == "300") %>%
  filter(Run != "56") %>%
  filter(Run != "59") %>%
  ggplot() +
  geom_point(aes(x = WL, y = OD720_Lmu_corr, colour = "#3C3B53"), size = 4, alpha = 0.8, show.legend = F) +
  #geom_point(aes(x = WL, y = deltaOD_Lmu_corr, colour = "#3C3B53"), size = 4, alpha = 0.8, show.legend = F) +
    geom_text(data=data_text2, aes(x=2.4, y=0.065, label=label), size=5) +
    geom_text(data=data_text24, aes(x=1, y=0.008, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text25, aes(x=2, y=0.002, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text26, aes(x=1, y=0.014, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text27, aes(x=2, y=0.011, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text32, aes(x=1, y=0.002, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text33, aes(x=2, y=0.013, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text34, aes(x=1, y=0.010, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text35, aes(x=2, y=0.026, label=label), size=4, color = '#3C3B53') +
labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Growth light (nm)") +
   geom_errorbar(aes(x = WL, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=0.3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
   #geom_errorbar(aes(x = WL, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), size = 0.3, width=0.3, color = '#3C3B53', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
  scale_y_continuous(breaks=seq(0, 0.06, by = 0.02)) +
  coord_cartesian(ylim = c (0, 0.075)) +
  scale_colour_discrete(type=c("#3C3B53", "#3C3B53"), name="") +
 ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, Photoperiod), labeller = labeller(WL = label_both, Strain = Strain.labs, Par_ue = Par_ue.labs, Photoperiod = Photoperiod.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=14),
        axis.title = element_text(size=17),
        strip.background = element_rect(fill="pink3"),
        strip.background.y = element_rect(fill="white"),
        strip.text = element_text(size=13),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.94),
        legend.text = element_text(size=12))
deltaOD_LmuSummaryGrowthPlot720

```



```{r fig.height = 10, fig.width = 8, warning = FALSE}
ggarrange(deltaOD_LmuSummaryGrowthPlotdelta, deltaOD_LmuSummaryGrowthPlot720,
          ncol = 1, nrow = 2)

```

Manuscript plot - growth -> x-WL different letter statistic
```{r fig.height = 6, fig.width = 8, warning = FALSE}


#OD720_2
Par_ue.labs <- c("60 µE", "300 µE")
names(Par_ue.labs) <- c("60", "300")
Strain.labs <- c("PE-rich", "PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  WL   = c("530", "660"),
  Par_ue = c(60, 300),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  label = c('A', 'B', 'C', 'D'))
data_text24 <- data.frame(Strain = c('BA127R'), Par_ue = c(60),label = c('b'))
data_text25 <- data.frame(Strain = c('BA127R'), Par_ue = c(60),label = c('c'))
data_text26 <- data.frame(Strain = c('BA127R'), Par_ue = c(300),label = c('a'))
data_text27 <- data.frame(Strain = c('BA127R'), Par_ue = c(300),label = c('ab'))

data_text32 <- data.frame(Strain = c('BA77G'), Par_ue = c(60),label = c('f'))
data_text33 <- data.frame(Strain = c('BA77G'), Par_ue = c(60),label = c('e'))
data_text34 <- data.frame(Strain = c('BA77G'), Par_ue = c(300),label = c('e'))
data_text35 <- data.frame(Strain = c('BA77G'), Par_ue = c(300),label = c('d'))

deltaOD_LmuSummaryGrowthPlot <- MultiCultiDataClean %>%
  filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  filter(Strain == "BA127R" | Strain == "BA77G") %>%
  filter(Photoperiod == "12") %>%
  filter(WL != "WW") %>%
  filter(WL != "450") %>%
  filter(WL != "620") %>%
  filter(Par_ue != "180") %>%
  filter(Par_ue == "60"| Par_ue == "300") %>%
  filter(Run != "56") %>%
  filter(Run != "59") %>%
  ggplot() +
  geom_point(aes(x = WL, y = OD720_Lmu_corr, colour = "#3C3B53"), size = 4, alpha = 0.8, show.legend = F) +
  #geom_point(aes(x = WL, y = deltaOD_Lmu_corr, colour = "#3C3B53"), size = 4, alpha = 0.8, show.legend = F) +
    geom_text(data=data_text2, aes(x=2.4, y=0.038, label=label), size=5) +
    geom_text(data=data_text24, aes(x=1, y=0.008, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text25, aes(x=2, y=0.002, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text26, aes(x=1, y=0.014, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text27, aes(x=2, y=0.011, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text32, aes(x=1, y=0.002, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text33, aes(x=2, y=0.013, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text34, aes(x=1, y=0.010, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text35, aes(x=2, y=0.026, label=label), size=4, color = '#3C3B53') +
labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Growth light (nm)") +
   geom_errorbar(aes(x = WL, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=0.3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
   #geom_errorbar(aes(x = WL, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), size = 0.3, width=0.3, color = '#3C3B53', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
  scale_y_continuous(breaks=seq(0, 0.04, by = 0.01)) +
  coord_cartesian(ylim = c (0, 0.04)) +
  scale_colour_discrete(type=c("#3C3B53", "#3C3B53"), name="") +
 ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue), labeller = labeller(WL = label_both, Photoperiod = label_both,  Strain = Strain.labs, Par_ue = Par_ue.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.12,0.94),
        legend.text = element_text(size=12))
deltaOD_LmuSummaryGrowthPlot




#Delta_2
#options(scipen = 1000)

Par_ue.labs <- c("Light level: 60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")
Strain.labs <- c("Strain: PE-rich", "Strain: PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  WL   = c("530", "660"),
  Par_ue = c(60, 300),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  label = c('A', 'B', 'C', 'D'))
data_text24 <- data.frame(Strain = c('BA127R'), Par_ue = c(60),label = c('b'))
data_text25 <- data.frame(Strain = c('BA127R'), Par_ue = c(60),label = c('c'))
data_text26 <- data.frame(Strain = c('BA127R'), Par_ue = c(300),label = c('a'))
data_text27 <- data.frame(Strain = c('BA127R'), Par_ue = c(300),label = c('b'))

data_text32 <- data.frame(Strain = c('BA77G'), Par_ue = c(60),label = c('f'))
data_text33 <- data.frame(Strain = c('BA77G'), Par_ue = c(60),label = c('e'))
data_text34 <- data.frame(Strain = c('BA77G'), Par_ue = c(300),label = c('e'))
data_text35 <- data.frame(Strain = c('BA77G'), Par_ue = c(300),label = c('d'))
deltaOD_LmuSummaryGrowthPlot <- MultiCultiDataClean %>%
  filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  filter(Strain == "BA127R" | Strain == "BA77G") %>%
  filter(Photoperiod == "12") %>%
  filter(WL != "WW") %>%
  filter(WL != "450") %>%
  filter(WL != "620") %>%
  filter(Par_ue != "180") %>%
  filter(Par_ue == "60"| Par_ue == "300") %>%
  filter(Run != "56") %>%
  filter(Run != "59") %>%
  ggplot() +
  #geom_point(aes(x = WL, y = OD720_Lmu_corr, colour = "OD 720"), size = 4, alpha = 0.9) +
  geom_point(aes(x = WL, y = deltaOD_Lmu_corr, colour = "#3C3B53"), size = 4, alpha = 0.8, show.legend = F) +
    geom_text(data=data_text2, aes(x=2.4, y=0.070, label=label), size=5) +
    geom_text(data=data_text24, aes(x=1, y=0.011, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text25, aes(x=2, y=0.003, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text26, aes(x=1, y=0.040, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text27, aes(x=2, y=0.014, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text32, aes(x=1, y=0.002, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text33, aes(x=2, y=0.013, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text34, aes(x=1, y=0.010, label=label), size=4, color = '#3C3B53') +
    geom_text(data=data_text35, aes(x=2, y=0.029, label=label), size=4, color = '#3C3B53') +
labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Growth light (nm)") +
   #geom_errorbar(aes(x = WL, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=0.3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
   geom_errorbar(aes(x = WL, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), size = 0.3, width=0.3, color = '#3C3B53', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
  #scale_y_log10() +
  #scale_y_continuous(breaks=seq(0, 0.06, by = 0.02)) +
  coord_cartesian(ylim = c (0.0001, 0.075)) +
  scale_colour_discrete(type=c("#3C3B53", "#3C3B53"), name="") +
 ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue), labeller = labeller(WL = label_both, Photoperiod = label_both,  Strain = Strain.labs, Par_ue = Par_ue.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.08,0.94),
        legend.text = element_text(size=12))
deltaOD_LmuSummaryGrowthPlot

```


# Save assembled spectra data set
```{r save Olis}

# saveRDS(OLISSpectraMetaAllPURDivided2, file.path(DataOut, paste(Project, "PURSySlRedGreenCCAok.Rds", sep = "_"), fsep = .Platform$file.sep))

# saveRDS(PURCombinedRound2, file.path(DataOut, paste(Project, "PURSySlRedGreenCCAoklong.Rds", sep = "_"), fsep = .Platform$file.sep))

```



Manuscript - PUR with subscript
```{r prelimplot2, fig.height = 5, fig.width = 8, warning = FALSE}

label1 <- "PUR[530]"
label2 <- "PUR[660]"

Par_ue.labs <- c("Light level: 60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")
WL.labs <- c("Growth light: 530 nm", "Growth light: 660 nm", "Growth light: 530 nm", "Growth light: 660 nm")
names(WL.labs) <- c("530", "660", "530", "660")
Strain.labs <- c("PE-rich", "PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  Par_ue = c(60, 60),
  WL   = c("530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  label = c('A', 'B', 'C', 'D'))

data_textPUR <- data.frame(Par_ue = c(60, 60), WL  = c("530", "660", "530", "660"), Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"), label = c(' =29', ' =15', ' =46', ' =17'))

data_textPUR2 <- data.frame(Par_ue = c(60, 60), WL  = c("530", "660", "530", "660"), Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"), label = c(' =15', ' =32', ' =19', ' =50'))


data_textpigment1 <- data.frame(
  Par_ue = c(60),WL   = c("530"),Strain  = c("BA127R"),label = c('Chl a 430-440 nm'))
data_textpigment2 <- data.frame(
  Par_ue = c(60),WL   = c("530"),Strain  = c("BA127R"),label = c('PE 570 nm'))
data_textpigment3 <- data.frame(
  Par_ue = c(60),WL   = c("530"),Strain  = c("BA127R"),label = c('Chl a 680 nm'))
data_textpigment4 <- data.frame(
  Par_ue = c(60),WL   = c("660"),Strain  = c("BA127R"),label = c('PC 620 nm'))

arrowdf1 <- tibble(Strain = "BA127R", WL = "530", Par_ue = 60)
arrowdf2 <- tibble(Strain = "BA127R", WL = "530", Par_ue = 60)
arrowdf3 <- tibble(Strain = "BA127R", WL = "530", Par_ue = 60)
arrowdf4 <- tibble(Strain = "BA127R", WL = "660", Par_ue = 60)

#dashed and solid color lines Norm440
OLISSpectra60 <- OLISSpectraMetaAllPURDivided2 %>%
  filter(Par_ue == 60) %>% 
  ggplot() +
  geom_line(aes(x = nm, y = AbsNorm440, colour = as.factor(WL), linetype = as.factor(WL)), alpha = 1, show.legend = F, size = 0.7) +
  geom_area(aes(x = nm, y = EmNormJaz530), fill = "chartreuse4", alpha = 0.3, show.legend = F, size = 0.5) +
  geom_area(aes(x = nm, y = PURNorm530), fill = "chartreuse4", alpha = 0.4, show.legend = F, size = 0.5) +
  geom_area(aes(x = nm, y = EmNormJaz660), fill = "brown3", alpha = 0.3, show.legend = F, size = 0.5) +
  geom_area(aes(x = nm, y = PURNorm660), fill = "brown3", alpha = 0.4, show.legend = F, size = 0.5) +

  geom_text(data=data_text2, aes(x=695, y=1.35, label=label), size=5) +
  geom_text(data=data_textPUR, aes(x=480, y=1.4, label=label),  size=4.5) +
  geom_text(data=data_textPUR2, aes(x=480, y=1.25, label=label),  size=4.5) +
  annotate("text", x=430, y=1.4, label=label1, parse=TRUE,  size=4.5) +
  annotate("text", x=430, y=1.25, label=label2, parse=TRUE,  size=4.5) +
  
  geom_text(data=data_textpigment1, aes(x=500, y=1.05, label=label), size=4, colour = "darkgreen") +
  geom_text(data=data_textpigment2, aes(x=580, y=0.8, label=label), size=4, colour = "darkmagenta") +
  geom_text(data=data_textpigment3, aes(x=650, y=1.2, label=label), size=4, colour = "darkgreen") +
  geom_text(data=data_textpigment4, aes(x=600, y=1, label=label), size=4, colour = "deepskyblue4") +
  
  #geom_segment(aes(x = 670, y = 1, xend = 680, yend = 0.6), arrow = arrow(length = unit(0.5, "cm"))) +
  geom_segment(data = arrowdf1, 
               aes(x = 480, xend = 450, y = 0.95, yend = 0.8), 
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) +
  geom_segment(data = arrowdf2, 
               aes(x = 590, xend = 575, y = 0.7, yend = 0.6), 
               colour = "darkmagenta", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + 
  geom_segment(data = arrowdf3, 
               aes(x = 660, xend = 680, y = 1.1, yend = 0.7), 
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) +
  geom_segment(data = arrowdf4, 
               aes(x = 600, xend = 620, y = 0.9, yend = 0.7), 
               colour = "deepskyblue4", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) +
  
  scale_linetype_manual(values=c("530" = "longdash", "660" = "solid")) +
  scale_color_manual(values = c("530" ="chartreuse4", "660" = "brown3")) +
  #guides(colour = FALSE, linetype = FALSE) +
  stat_wl_strip(aes(x = nm), alpha = 0.5, ymin = -Inf, ymax = -0.05) + 
  scale_fill_identity() +
  labs(y = "Normalized absorbance", x = "Wavelength (nm)") +
  scale_y_continuous(breaks=seq(0, 1.5, by = 0.5)) +
  coord_cartesian(ylim = c (-0.10, 1.5)) +
  # scale_x_continuous(breaks=seq(400, 700, by = 100)) +
  # coord_cartesian(xlim = c (380, 720)) +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, Photoperiod = label_both, Par_ue = Par_ue.labs, Strain = Strain.labs, WL = WL.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=14),
        axis.text.x = element_blank(),
        axis.title = element_text(size=17),
        strip.background = element_rect(fill="pink3"),
        strip.background.y = element_rect(fill="white"),
        strip.text = element_text(size=13),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.94),
        legend.text = element_text(size=12))
OLISSpectra60



```


Manuscript - PUR with subscript
```{r prelimplot2, fig.height = 6, fig.width = 8, warning = FALSE}

label1 <- "PUR[530]"
label2 <- "PUR[660]"

Par_ue.labs <- c("Light level: 60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")
WL.labs <- c("Growth light: 530 nm", "Growth light: 660 nm", "Growth light: 530 nm", "Growth light: 660 nm")
names(WL.labs) <- c("530", "660", "530", "660")
Strain.labs <- c("PE-rich", "PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  Par_ue = c(300, 300),
  WL   = c("530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"),
  label = c('E', 'F', 'G', 'H'))

data_textPUR <- data.frame(Par_ue = c(300, 300), WL  = c("530", "660", "530", "660"), Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"), label = c('   =202', ' =77', '   =157', ' =78'))

data_textPUR2 <- data.frame(Par_ue = c(300, 300), WL  = c("530", "660", "530", "660"), Strain  = c("BA127R", "BA127R", "BA77G", "BA77G"), label = c(' =89', '   =189', ' =71', '   =196'))

#dashed and solid color lines Norm440
OLISSpectra300 <- OLISSpectraMetaAllPURDivided2 %>%
  filter(Par_ue == 300) %>% 
  ggplot() +
  geom_line(aes(x = nm, y = AbsNorm440, colour = as.factor(WL), linetype = as.factor(WL)), alpha = 1, show.legend = F, size = 0.7) +
  geom_area(aes(x = nm, y = EmNormJaz530), fill = "chartreuse4", alpha = 0.3, show.legend = F, size = 0.5) +
  geom_area(aes(x = nm, y = PURNorm530), fill = "chartreuse4", alpha = 0.4, show.legend = F, size = 0.5) +
  geom_area(aes(x = nm, y = EmNormJaz660), fill = "brown3", alpha = 0.3, show.legend = F, size = 0.5) +
  geom_area(aes(x = nm, y = PURNorm660), fill = "brown3", alpha = 0.4, show.legend = F, size = 0.5) +

  geom_text(data=data_text2, aes(x=695, y=1.35, label=label), size=5) +
  geom_text(data=data_textPUR, aes(x=480, y=1.4, label=label),  size=4.5) +
  geom_text(data=data_textPUR2, aes(x=480, y=1.25, label=label),  size=4.5) +
  annotate("text", x=430, y=1.4, label=label1, parse=TRUE,  size=4.5) +
  annotate("text", x=430, y=1.25, label=label2, parse=TRUE,  size=4.5) +
  
  scale_linetype_manual(values=c("530" = "longdash", "660" = "solid")) +
  scale_color_manual(values = c("530" ="chartreuse4", "660" = "brown3")) +
  stat_wl_strip(aes(x = nm), alpha = 0.5, ymin = -Inf, ymax = -0.05) + 
  scale_fill_identity() +
  labs(y = "Normalized absorbance", x = "Wavelength (nm)") +
  scale_y_continuous(breaks=seq(0, 1.5, by = 0.5)) +
  coord_cartesian(ylim = c (-0.10, 1.5)) +
  # scale_x_continuous(breaks=seq(400, 700, by = 100)) +
  # coord_cartesian(xlim = c (380, 720)) +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, Photoperiod = label_both, Par_ue = Par_ue.labs, Strain = Strain.labs, WL = WL.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=14),
        axis.title = element_text(size=17),
        strip.background = element_rect(fill="pink3"),
        strip.background.y = element_rect(fill="white"),
        strip.text = element_text(size=13),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.94),
        legend.text = element_text(size=12))
OLISSpectra300


```

```{r fig.height = 11, fig.width = 8, warning = FALSE}

  ggarrange(OLISSpectra60, OLISSpectra300,
          ncol = 1, nrow = 2)

```

Manuscript - PUR with subscript
```{r prelimplot2, fig.height = 6, fig.width = 8, warning = FALSE}

label1 <- "PUR[530]"
label2 <- "PUR[660]"

Par_ue.labs <- c("Light level: 60 µE", "Light level: 300 µE")
names(Par_ue.labs) <- c("60", "300")
WL.labs <- c("Growth light: 530 nm", "Growth light: 660 nm", "Growth light: 530 nm", "Growth light: 660 nm")
names(WL.labs) <- c("530", "660", "530", "660")
Strain.labs <- c("Strain: PE-rich", "Strain: PC-rich")
names(Strain.labs) <- c("BA127R", "BA77G")

data_text2 <- data.frame(
  Par_ue = c(60, 60, 300, 300, 60, 60, 300, 300),
  WL   = c("530", "660", "530", "660", "530", "660", "530", "660"),
  Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"),
  label = c('A', 'B', 'C', 'D', "E", "F", "G", "H"))


data_textPUR <- data.frame(Par_ue = c(60, 60, 300, 300), WL  = c("530", "660", "530", "660"), Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"), label = c(' =29', ' =15', '   =202', ' =77', ' =46', ' =17', '   =157', ' =78'))

# data_textPUR <- data.frame(Par_ue = c(60, 60, 300, 300), WL  = c("530", "660", "530", "660"), Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"), label = c('PUR=28.72882', 'PUR=14.96051', 'PUR=201.5769', 'PUR=77.29118', 'PUR=46.41589', 'PUR=17.42997', 'PUR=157.11375', 'PUR=78.44766'))

data_textPUR2 <- data.frame(Par_ue = c(60, 60, 300, 300), WL  = c("530", "660", "530", "660"), Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"), label = c(' =15', ' =32', ' =89', '   =189', ' =19', ' =50', ' =71', '   =196'))


# data_textPUR2 <- data.frame(Par_ue = c(60, 60, 300, 300), WL  = c("530", "660", "530", "660"), Strain  = c("BA127R", "BA127R", "BA127R", "BA127R", "BA77G", "BA77G", "BA77G", "BA77G"), label = c('PUR=14.65867', 'PUR=31.75647', 'PUR=89.42922', 'PUR=189.24759', 'PUR=18.81333', 'PUR=50.18462', 'PUR=70.86619', 'PUR=195.71561'))

#dashed and solid color lines Norm440
OLISSpectraMetaAllPUR2Plot <- OLISSpectraMetaAllPURDivided2 %>%
  ggplot() +
  geom_line(aes(x = nm, y = AbsNorm440, colour = as.factor(WL), linetype = as.factor(WL)), alpha = 1, show.legend = F, size = 0.7) +
  geom_area(aes(x = nm, y = EmNormJaz530), fill = "chartreuse4", alpha = 0.3, show.legend = F, size = 0.5) +
  geom_area(aes(x = nm, y = PURNorm530), fill = "chartreuse4", alpha = 0.4, show.legend = F, size = 0.5) +
  geom_area(aes(x = nm, y = EmNormJaz660), fill = "brown3", alpha = 0.3, show.legend = F, size = 0.5) +
  geom_area(aes(x = nm, y = PURNorm660), fill = "brown3", alpha = 0.4, show.legend = F, size = 0.5) +
  
  geom_text(data=data_text2, aes(x=695, y=1.35, label=label), size=5) +
  geom_text(data=data_textPUR, aes(x=500, y=1.4, label=label), size=3.5) +
  geom_text(data=data_textPUR2, aes(x=500, y=1.25, label=label), size=3.5) +
  
  annotate("text", x=430, y=1.4, label=label1, parse=TRUE, size=3.5) +
  annotate("text", x=430, y=1.25, label=label2, parse=TRUE, size=3.5) +  
  
  scale_linetype_manual(values=c("530" = "longdash", "660" = "solid")) +
  scale_color_manual(values = c("530" ="chartreuse4", "660" = "brown3")) +
  #guides(colour = FALSE, linetype = FALSE) +
  
  stat_wl_strip(aes(x = nm), alpha = 0.5, ymin = -Inf, ymax = -0.03) + 
  scale_fill_identity() +
  
  labs(y = "Normalized absorbance", x = "Wavelength (nm)") +
  scale_y_continuous(breaks=seq(0, 1.5, by = 0.3)) +
  coord_cartesian(ylim = c (-0.1, 1.5)) +
  scale_x_continuous(breaks=seq(400, 700, by = 100)) +
  coord_cartesian(xlim = c (380, 720)) +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Par_ue, WL), labeller = labeller(Ex_WL = label_both, Photoperiod = label_both, Par_ue = Par_ue.labs, Strain = Strain.labs, WL = WL.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.94),
        legend.text = element_text(size=12))
OLISSpectraMetaAllPUR2Plot




```



```{r fig.height = 12, fig.width = 8, warning = FALSE}
# library("cowplot")
# 
#   combined_plot<-plot_grid(OLISSpectra60, OLISSpectra300, ncol = 1, nrow = 2)
#   combined_plot
```




